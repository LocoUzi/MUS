<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUS System - Bost√∏tten Viborg</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #667eea;
        }

        .loading:after {
            content: '...';
            animation: dots 1.5s steps(4, end) infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input[type="email"],
        input[type="text"],
        input[type="password"],
        input[type="date"],
        input[type="time"],
        input[type="datetime-local"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .btn-small {
            width: auto;
            padding: 8px 16px;
            font-size: 14px;
            margin: 5px;
        }

        .code-display {
            background: #f0f3ff;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .code-display .code {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 5px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #f0f3ff;
            color: #004085;
            border: 1px solid #667eea;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .alert-warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }

        .question-section {
            background: #fafafa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 4px solid #667eea;
        }

        .question-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #764ba2;
        }

        .question {
            margin-bottom: 25px;
        }

        .question-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: block;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .radio-option input[type="radio"] {
            width: auto;
        }

        .employee-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .employee-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .employee-card h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .employee-card .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover {
            color: #667eea;
        }

        .time-slot-card {
            background: #f8f9fa;
            border: 2px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .time-slot-card.booked {
            background: #d4edda;
            border-color: #c3e6cb;
        }

        .time-slot-info {
            flex: 1;
        }

        .time-slot-actions {
            display: flex;
            gap: 10px;
        }

        .navigation-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .navigation-buttons button {
            flex: 1;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .radio-group {
                flex-direction: column;
            }

            .navigation-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è MUS System</h1>
            <p>Bost√∏tten Viborg - Medarbejderudviklingssamtaler</p>
        </div>

        <!-- Loading Screen -->
        <div id="loadingScreen" class="screen active">
            <div class="loading">
                <h2>Indl√¶ser system</h2>
                <p>Forbinder til database</p>
            </div>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="screen">
            <div class="form-group">
                <label for="loginType">V√¶lg logintype:</label>
                <select id="loginType" onchange="toggleLoginType()">
                    <option value="employee">Medarbejder</option>
                    <option value="leader">Leder</option>
                </select>
            </div>

            <div id="employeeLogin">
                <div id="newUserLogin">
                    <div class="form-group">
                        <label for="employeeEmail">Din arbejds-email:</label>
                        <input type="email" id="employeeEmail" placeholder="din.email@viborg.dk">
                    </div>
                    <div class="form-group">
                        <label for="employeeCluster">V√¶lg dit team:</label>
                        <select id="employeeCluster">
                            <option value="">-- V√¶lg team --</option>
                            <option value="1">Team 1</option>
                            <option value="2">Team 2</option>
                            <option value="3">Team 3</option>
                            <option value="4">Team 4</option>
                            <option value="5">Team 5</option>
                            <option value="√òvrige">√òvrige personale</option>
                        </select>
                    </div>
                    <button class="btn" onclick="sendCode()">Send engangskode</button>
                    
                    <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                        <p style="color: #666; margin-bottom: 10px;">Har du allerede en kode?</p>
                        <button class="btn btn-secondary" onclick="showDirectLogin()">Log ind med kode</button>
                    </div>
                </div>

                <div id="directCodeLogin" style="display: none;">
                    <div class="form-group">
                        <label for="directEmail">Din arbejds-email:</label>
                        <input type="email" id="directEmail" placeholder="din.email@viborg.dk">
                    </div>
                    <div class="form-group">
                        <label for="directCluster">V√¶lg dit team:</label>
                        <select id="directCluster">
                            <option value="">-- V√¶lg team --</option>
                            <option value="1">Team 1</option>
                            <option value="2">Team 2</option>
                            <option value="3">Team 3</option>
                            <option value="4">Team 4</option>
                            <option value="5">Team 5</option>
                            <option value="√òvrige">√òvrige personale</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="directCode">Din 4-cifrede kode:</label>
                        <input type="text" id="directCode" placeholder="Indtast din kode" maxlength="4">
                    </div>
                    <button class="btn" onclick="directLogin()">Log ind</button>
                    
                    <div style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid #e0e0e0;">
                        <p style="color: #666; margin-bottom: 10px;">Har du ikke en kode endnu?</p>
                        <button class="btn btn-secondary" onclick="showNewUserLogin()">F√• tilsendt kode</button>
                    </div>
                </div>
            </div>

            <div id="leaderLogin" style="display: none;">
                <div class="form-group">
                    <label for="leaderUsername">Brugernavn:</label>
                    <input type="text" id="leaderUsername" placeholder="Susanne / Dan">
                </div>
                <div class="form-group">
                    <label for="leaderPassword">Adgangskode:</label>
                    <input type="password" id="leaderPassword" placeholder="Indtast adgangskode">
                </div>
                <button class="btn" onclick="leaderLogin()">Log ind som leder</button>
            </div>
        </div>

        <!-- Code Verification Screen -->
        <div id="codeScreen" class="screen">
            <div class="alert alert-success" id="codeScreenMessage">
                <strong>üìß Kode sendt til din email!</strong><br>
                Tjek din email-indbakke og indtast den 4-cifrede kode nedenfor.
            </div>

            <div class="form-group">
                <label for="codeInput">Indtast engangskode fra email:</label>
                <input type="text" id="codeInput" placeholder="Indtast 4-cifret kode" maxlength="4">
            </div>

            <button class="btn" onclick="verifyCode()">Verificer kode</button>
            <button class="btn btn-success" onclick="resendCodeByEmail()" style="margin-top: 10px;">üìß Send kode igen</button>
            <button class="btn btn-secondary" onclick="goToLogin()">Tilbage</button>
        </div>

        <!-- Employee Dashboard -->
        <div id="employeeDashboard" class="screen">
            <div class="alert alert-success">
                Velkommen, <span id="employeeName"></span>!
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showEmployeeTab('booking')">üìÖ Book MUS</button>
                <button class="tab" onclick="showEmployeeTab('questionnaire')">üìù Sp√∏rgeskema</button>
            </div>

            <!-- Booking Tab -->
            <div id="bookingTab" class="tab-content">
                <h3>Book din MUS-samtale</h3>
                <p style="margin-bottom: 20px; color: #666;">
                    V√¶lg din leder og en ledig tid nedenfor.
                </p>

                <div class="form-group">
                    <label for="bookingLeader">V√¶lg din leder:</label>
                    <select id="bookingLeader" onchange="loadAvailableTimes()">
                        <option value="">-- V√¶lg leder --</option>
                        <option value="Susanne">Susanne</option>
                        <option value="Dan">Dan</option>
                    </select>
                </div>

                <div id="availableTimesContainer" style="display: none;">
                    <div class="form-group">
                        <label for="bookingTimeSlot">V√¶lg ledig tid:</label>
                        <select id="bookingTimeSlot">
                            <option value="">-- V√¶lg tid --</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="musNotes">Evt. bem√¶rkninger:</label>
                        <textarea id="musNotes" placeholder="F.eks. 'Jeg ser frem til samtalen'"></textarea>
                    </div>

                    <button class="btn" onclick="bookMUS()">Book MUS og send invitation</button>
                </div>
            </div>

            <!-- Questionnaire Tab -->
            <div id="questionnaireTab" class="tab-content" style="display: none;">
                <div id="questionnaireForm"></div>
            </div>

            <button class="btn btn-secondary" onclick="logout()" style="margin-top: 30px;">Log ud</button>
        </div>

        <!-- Leader Dashboard -->
        <div id="leaderDashboard" class="screen">
            <div class="alert alert-success">
                Velkommen, <span id="leaderNameDisplay"></span>!
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showLeaderTab('timeslots')">üïê Ledige tider</button>
                <button class="tab" onclick="showLeaderTab('employees')">üë• Medarbejdere</button>
                <button class="tab" onclick="showLeaderTab('questions')">‚öôÔ∏è Rediger sp√∏rgsm√•l</button>
                <button class="tab" onclick="showLeaderTab('settings')">üîß Indstillinger</button>
            </div>

            <!-- Time Slots Tab -->
            <div id="timeslotsTab" class="tab-content">
                <h3>Mine ledige tider</h3>
                <p style="margin-bottom: 20px; color: #666;">
                    Opret tider som dine medarbejdere kan booke.
                </p>

                <div class="question-section">
                    <h3>Tilf√∏j ny ledig tid</h3>
                    <div class="form-group">
                        <label for="newTimeSlot">V√¶lg dato og tidspunkt:</label>
                        <input type="datetime-local" id="newTimeSlot">
                    </div>
                    <button class="btn btn-success" onclick="addTimeSlot()">Tilf√∏j tid</button>
                </div>

                <h3 style="margin-top: 30px;">Dine tider:</h3>
                <div id="timeSlotsList"></div>
            </div>

            <!-- Employees Tab -->
            <div id="employeesTab" class="tab-content" style="display: none;">
                <h3>Alle medarbejderes MUS</h3>
                <div class="form-group" style="margin-bottom: 30px;">
                    <label for="leaderClusterSelect">V√¶lg team at se:</label>
                    <select id="leaderClusterSelect" onchange="changeLeaderCluster()">
                        <option value="">-- V√¶lg team --</option>
                        <option value="1">Team 1</option>
                        <option value="2">Team 2</option>
                        <option value="3">Team 3</option>
                        <option value="4">Team 4</option>
                        <option value="5">Team 5</option>
                        <option value="√òvrige">√òvrige personale</option>
                    </select>
                </div>
                <div id="employeesList"></div>
            </div>

            <!-- Questions Tab -->
            <div id="questionsTab" class="tab-content" style="display: none;">
                <h3>Rediger standard MUS-sp√∏rgsm√•l</h3>
                <p style="margin-bottom: 20px; color: #666;">
                    Disse sp√∏rgsm√•l er f√¶lles for alle medarbejdere. Du kan redigere dem her.
                </p>
                <div id="questionsEditor"></div>
                <button class="btn btn-success" onclick="saveQuestions(event)">Gem √¶ndringer</button>
            </div>

            <!-- Settings Tab -->
            <div id="settingsTab" class="tab-content" style="display: none;">
                <h3>Indstillinger</h3>
                
                <div class="question-section">
                    <h3>Skift adgangskode</h3>
                    <div class="form-group">
                        <label for="currentPassword">Nuv√¶rende adgangskode:</label>
                        <input type="password" id="currentPassword">
                    </div>
                    <div class="form-group">
                        <label for="newPassword">Ny adgangskode:</label>
                        <input type="password" id="newPassword">
                    </div>
                    <div class="form-group">
                        <label for="confirmPassword">Bekr√¶ft ny adgangskode:</label>
                        <input type="password" id="confirmPassword">
                    </div>
                    <button class="btn btn-success" onclick="changePassword()">Skift adgangskode</button>
                </div>
            </div>

            <button class="btn btn-secondary" onclick="logout()" style="margin-top: 30px;">Log ud</button>
        </div>

        <!-- Employee Detail View -->
        <div id="employeeDetailScreen" class="screen">
            <button class="btn btn-secondary" onclick="backToLeaderDashboard()" style="margin-bottom: 20px;">‚Üê Tilbage til oversigt</button>
            
            <h2 id="detailEmployeeName"></h2>
            <div id="detailBookingInfo" class="alert alert-info"></div>
            
            <div id="detailAnswers"></div>

            <div class="navigation-buttons">
                <button class="btn btn-success" onclick="exportToPDF()">üìÑ Gem som PDF-dokument</button>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
        import { getDatabase, ref, set, get, push, remove, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

        // Firebase configuration
        const firebaseConfig = {
            apiKey: "AIzaSyBL4nrgkARGOdJ9MJQ4g5o_uBh5WS4sfls",
            authDomain: "mus-bostotten.firebaseapp.com",
            databaseURL: "https://mus-bostotten-default-rtdb.europe-west1.firebasedatabase.app/",
            projectId: "mus-bostotten",
            storageBucket: "mus-bostotten.firebasestorage.app",
            messagingSenderId: "1075473579556",
            appId: "1:1075473579556:web:c9c7af365c9b5b90d222b1"
        };

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const database = getDatabase(app);

        // Make Firebase globally available
        window.firebaseDB = database;
        window.firebaseRef = ref;
        window.firebaseSet = set;
        window.firebaseGet = get;
        window.firebasePush = push;
        window.firebaseRemove = remove;
        window.firebaseOnValue = onValue;
        window.firebaseUpdate = update;

        // Initialize system once Firebase is ready
        window.initSystem();
    </script>

    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <script>
        // Initialize EmailJS
        (function(){
            emailjs.init("AOph8BmgR9nAcQZzA");
        })();
    </script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // State management
        let currentUser = null;
        let currentCode = null;
        let isLeader = false;
        let currentLeader = null;
        let currentEmployeeDetail = null;
        let selectedLeaderCluster = null;
        let cachedTimeSlots = {};
        let cachedQuestions = null;

        // EmailJS configuration
        const EMAILJS_SERVICE_ID = "service_9dwo3bb";
        const EMAILJS_TEMPLATE_ID = "template_2qjtfi6";

        // Leader emails
        const LEADER_EMAILS = {
            'Susanne': 'sa3@viborg.dk',
            'Dan': 'dahn@viborg.dk'
        };

        // Default MUS questions
        const DEFAULT_QUESTIONS = [
            {
                section: "Opf√∏lgning siden sidst",
                questions: [
                    {
                        id: "q1",
                        text: "Hvordan er det g√•et med opf√∏lgning p√• aftaler om udvikling?",
                        type: "textarea",
                        answer: ""
                    },
                    {
                        id: "q2",
                        text: "Hvad er g√•et godt, og hvad kendetegner de situationer eller opgaver?",
                        type: "textarea",
                        answer: ""
                    },
                    {
                        id: "q3",
                        text: "Hvad ville jeg gerne v√¶re lykkedes bedre med? Og hvad skulle have v√¶ret anderledes, for at n√• i m√•l?",
                        type: "textarea",
                        answer: ""
                    },
                    {
                        id: "q4",
                        text: "Hvilke resultater er jeg mest glad for at have opn√•et?",
                        type: "textarea",
                        answer: ""
                    }
                ]
            },
            {
                section: "Organisatoriske rammer og opgaver",
                questions: [
                    {
                        id: "q5",
                        text: "Jeg har kendskab til de rammer, m√•ls√¶tninger og prioriteringer som arbejdspladsen arbejder efter",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q6",
                        text: "Min n√¶rmeste leder er god til at s√¶tte klare m√•l for arbejdspladsen",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q7",
                        text: "Jeg form√•r at bidrage aktivt og konstruktivt til arbejdspladsens udvikling og opgavel√∏sning",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q8",
                        text: "Jeg har en forst√•else for min rolle p√• arbejdspladsen og ved hvilke kompetencer jeg kan byde ind med",
                        type: "scale",
                        answer: "",
                        followup: ""
                    }
                ]
            },
            {
                section: "Relationer og samarbejde",
                questions: [
                    {
                        id: "q9",
                        text: "Jeg bidrager aktivt til et godt samarbejde med kolleger, samarbejdspartnere og ledere",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q10",
                        text: "Jeg tager ansvar for f√¶lles resultatskabelse og f√¶lles arbejdsgl√¶de og trivsel",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q11",
                        text: "Jeg kan f√• st√∏tte og vejledning, n√•r jeg har behov for det",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q12",
                        text: "Jeg f√•r tilbagemeldinger om kvalitet af det arbejde, jeg udf√∏rer",
                        type: "scale",
                        answer: "",
                        followup: ""
                    }
                ]
            },
            {
                section: "Kompetencer og udvikling",
                questions: [
                    {
                        id: "q13",
                        text: "Hvor ser jeg mit behov for udvikling i kompetencer og opgaver ift. arbejdspladsens opgavel√∏sning?",
                        type: "textarea",
                        answer: ""
                    },
                    {
                        id: "q14",
                        text: "Jeg har mulighed for at l√¶re nyt og udvikle mig gennem mit arbejde",
                        type: "scale",
                        answer: "",
                        followup: ""
                    }
                ]
            },
            {
                section: "Tilknytning til arbejdspladsen",
                questions: [
                    {
                        id: "q15",
                        text: "N√•r vi har MUS-samtale igen til n√¶ste √•r (eller om 5 √•r), hvad har s√• v√¶ret medvirkende til at vi har kunne fastholde dig?",
                        type: "textarea",
                        answer: ""
                    },
                    {
                        id: "q16",
                        text: "Er der s√¶rlige forhold, vi som arbejdsplads skal tage hensyn til/b√∏r kende for at sikre din fortsatte tilknytning?",
                        type: "textarea",
                        answer: ""
                    },
                    {
                        id: "q17",
                        text: "Er der behov for at kigge p√• arbejds- og opgavetilrettel√¶ggelse/ressourcer i forhold til tilknytning p√• kort og langt sigt?",
                        type: "textarea",
                        answer: ""
                    }
                ]
            },
            {
                section: "Konkrete aftaler om udvikling",
                questions: [
                    {
                        id: "q18",
                        text: "Hvilke 1-2 udviklingsm√•l er relevante for det kommende √•r? Hvilke indsatser kr√¶ver de?",
                        type: "textarea",
                        answer: ""
                    }
                ]
            }
        ];

        // Default leader passwords
        const DEFAULT_LEADER_PASSWORDS = {
            'Susanne': 'Susanne1',
            'Dan': 'Dan1'
        };

        // Initialize system
        window.initSystem = async function() {
            try {
                // Initialize default data if not exists
                await initializeDefaultData();
                
                // Hide loading screen
                showScreen('loginScreen');
            } catch (error) {
                console.error('Initialization error:', error);
                alert('Fejl ved indl√¶sning af system. Genindl√¶s venligst siden.');
            }
        };

        // Initialize default data in Firebase
        async function initializeDefaultData() {
            // Check and initialize leader passwords
            const passwordsRef = window.firebaseRef(window.firebaseDB, 'leaderPasswords');
            const passwordsSnapshot = await window.firebaseGet(passwordsRef);
            
            if (!passwordsSnapshot.exists()) {
                await window.firebaseSet(passwordsRef, DEFAULT_LEADER_PASSWORDS);
            }

            // Check and initialize questions
            const questionsRef = window.firebaseRef(window.firebaseDB, 'questions');
            const questionsSnapshot = await window.firebaseGet(questionsRef);
            
            if (!questionsSnapshot.exists()) {
                await window.firebaseSet(questionsRef, DEFAULT_QUESTIONS);
            }

            // Initialize time slots structure for each leader
            const leaders = ['Susanne', 'Dan'];
            for (const leader of leaders) {
                const slotsRef = window.firebaseRef(window.firebaseDB, `timeSlots/${leader}`);
                const slotsSnapshot = await window.firebaseGet(slotsRef);
                
                if (!slotsSnapshot.exists()) {
                    await window.firebaseSet(slotsRef, {});
                }
            }
        }

        // Firebase helper functions
        async function getMUSData(email) {
            const dataRef = window.firebaseRef(window.firebaseDB, `musData/${email.replace(/\./g, '_')}`);
            const snapshot = await window.firebaseGet(dataRef);
            return snapshot.exists() ? snapshot.val() : null;
        }

        async function saveMUSData(email, data) {
            const dataRef = window.firebaseRef(window.firebaseDB, `musData/${email.replace(/\./g, '_')}`);
            await window.firebaseSet(dataRef, data);
        }

        async function getAllMUSData() {
            const dataRef = window.firebaseRef(window.firebaseDB, 'musData');
            const snapshot = await window.firebaseGet(dataRef);
            
            if (!snapshot.exists()) {
                return {};
            }

            const data = snapshot.val();
            const result = {};
            
            // Convert back underscores to dots in email keys
            for (const key in data) {
                const email = key.replace(/_/g, '.');
                result[email] = data[key];
            }
            
            return result;
        }

        async function getQuestions() {
            if (cachedQuestions) {
                return cachedQuestions;
            }
            
            const questionsRef = window.firebaseRef(window.firebaseDB, 'questions');
            const snapshot = await window.firebaseGet(questionsRef);
            cachedQuestions = snapshot.exists() ? snapshot.val() : DEFAULT_QUESTIONS;
            return cachedQuestions;
        }

        async function saveQuestions(questions) {
            const questionsRef = window.firebaseRef(window.firebaseDB, 'questions');
            await window.firebaseSet(questionsRef, questions);
            cachedQuestions = questions;
        }

        async function getLeaderPasswords() {
            const passwordsRef = window.firebaseRef(window.firebaseDB, 'leaderPasswords');
            const snapshot = await window.firebaseGet(passwordsRef);
            return snapshot.exists() ? snapshot.val() : DEFAULT_LEADER_PASSWORDS;
        }

        async function saveLeaderPasswords(passwords) {
            const passwordsRef = window.firebaseRef(window.firebaseDB, 'leaderPasswords');
            await window.firebaseSet(passwordsRef, passwords);
        }

        async function getTimeSlots(leader) {
            const slotsRef = window.firebaseRef(window.firebaseDB, `timeSlots/${leader}`);
            const snapshot = await window.firebaseGet(slotsRef);
            
            if (!snapshot.exists()) {
                return [];
            }

            const data = snapshot.val();
            const slots = [];
            
            for (const key in data) {
                slots.push({
                    id: key,
                    ...data[key]
                });
            }
            
            return slots.sort((a, b) => new Date(a.datetime) - new Date(b.datetime));
        }

        async function addTimeSlotToDB(leader, datetime) {
            const slotsRef = window.firebaseRef(window.firebaseDB, `timeSlots/${leader}`);
            const newSlotRef = window.firebasePush(slotsRef);
            
            await window.firebaseSet(newSlotRef, {
                datetime: datetime,
                bookedBy: null,
                bookedByName: null
            });
            
            return newSlotRef.key;
        }

        async function deleteTimeSlotFromDB(leader, slotId) {
            const slotRef = window.firebaseRef(window.firebaseDB, `timeSlots/${leader}/${slotId}`);
            await window.firebaseRemove(slotRef);
        }

        async function updateTimeSlot(leader, slotId, data) {
            const slotRef = window.firebaseRef(window.firebaseDB, `timeSlots/${leader}/${slotId}`);
            await window.firebaseUpdate(slotRef, data);
        }

        // Login functions
        function toggleLoginType() {
            const type = document.getElementById('loginType').value;
            document.getElementById('employeeLogin').style.display = type === 'employee' ? 'block' : 'none';
            document.getElementById('leaderLogin').style.display = type === 'leader' ? 'block' : 'none';
        }

        function showDirectLogin() {
            document.getElementById('newUserLogin').style.display = 'none';
            document.getElementById('directCodeLogin').style.display = 'block';
        }

        function showNewUserLogin() {
            document.getElementById('newUserLogin').style.display = 'block';
            document.getElementById('directCodeLogin').style.display = 'none';
        }

        async function directLogin() {
            const email = document.getElementById('directEmail').value.trim();
            const cluster = document.getElementById('directCluster').value;
            const code = document.getElementById('directCode').value.trim();

            if (!email || !email.includes('@')) {
                alert('Indtast venligst en gyldig email-adresse');
                return;
            }

            if (!cluster) {
                alert('V√¶lg venligst dit team');
                return;
            }

            if (!code || code.length !== 4) {
                alert('Indtast venligst din 4-cifrede kode');
                return;
            }

            try {
                const userData = await getMUSData(email);

                if (!userData) {
                    alert('Email ikke fundet. Hvis det er din f√∏rste gang, skal du f√• tilsendt en kode.');
                    return;
                }

                if (userData.permanentCode !== code) {
                    alert('Forkert kode. Pr√∏v igen.');
                    return;
                }

                // Update cluster if changed
                if (userData.cluster !== cluster) {
                    userData.cluster = cluster;
                    await saveMUSData(email, userData);
                }

                // Set current user
                currentUser = {
                    email: email,
                    name: userData.name,
                    cluster: cluster
                };
                currentCode = code;
                isLeader = false;

                await showEmployeeDashboard();

            } catch (error) {
                console.error('Direct login error:', error);
                alert('Fejl ved login. Pr√∏v igen.');
            }
        }

        async function sendCode() {
            const email = document.getElementById('employeeEmail').value.trim();
            const cluster = document.getElementById('employeeCluster').value;
            
            if (!email || !email.includes('@')) {
                alert('Indtast venligst en gyldig email-adresse');
                return;
            }

            if (!cluster) {
                alert('V√¶lg venligst din team');
                return;
            }

            try {
                // Show loading
                const loginBtn = event.target;
                loginBtn.disabled = true;
                loginBtn.textContent = 'Sender email...';

                const userData = await getMUSData(email);
                let permanentCode;
                
                if (userData && userData.permanentCode) {
                    permanentCode = userData.permanentCode;
                } else {
                    permanentCode = Math.floor(1000 + Math.random() * 9000).toString();
                    
                    const questions = await getQuestions();
                    const newUserData = {
                        name: email.split('@')[0],
                        email: email,
                        cluster: cluster,
                        permanentCode: permanentCode,
                        booking: null,
                        answers: questions
                    };
                    
                    await saveMUSData(email, newUserData);
                }

                currentCode = permanentCode;
                currentUser = { 
                    email: email, 
                    name: email.split('@')[0],
                    cluster: cluster
                };

                // Send email automatically
                const templateParams = {
                    to_email: currentUser.email,
                    user_name: currentUser.name,
                    passcode: currentCode,
                    time: '1 time'
                };

                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
                
                // Show code screen
                const isFirstTime = !userData || !userData.permanentCode;
                const message = document.getElementById('codeScreenMessage');
                
                if (isFirstTime) {
                    message.innerHTML = `
                        <strong>‚úÖ Kode sendt til ${email}!</strong><br>
                        Dette er din <strong>faste kode</strong>. Du f√•r samme kode hver gang du logger ind.<br>
                        Tjek din email-indbakke og indtast koden nedenfor.
                    `;
                } else {
                    message.innerHTML = `
                        <strong>‚úÖ Velkommen tilbage!</strong><br>
                        Din faste kode er sendt til ${email}.<br>
                        Tjek din email-indbakke og indtast koden nedenfor.
                    `;
                }
                
                showScreen('codeScreen');
                
                // Re-enable button
                loginBtn.disabled = false;
                loginBtn.textContent = 'Send engangskode';
                
            } catch (error) {
                console.error('Send code error:', error);
                alert('‚ùå Kunne ikke sende email. Tjek at din email-adresse er korrekt og pr√∏v igen.');
                
                // Re-enable button
                const loginBtn = document.querySelector('#employeeLogin .btn');
                if (loginBtn) {
                    loginBtn.disabled = false;
                    loginBtn.textContent = 'Send engangskode';
                }
            }
        }

        async function verifyCode() {
            const inputCode = document.getElementById('codeInput').value;

            if (inputCode === currentCode) {
                isLeader = false;
                
                try {
                    const userData = await getMUSData(currentUser.email);
                    
                    if (!userData) {
                        const questions = await getQuestions();
                        const newUserData = {
                            name: currentUser.name,
                            email: currentUser.email,
                            cluster: currentUser.cluster,
                            permanentCode: currentCode,
                            booking: null,
                            answers: questions
                        };
                        await saveMUSData(currentUser.email, newUserData);
                    } else {
                        // Update cluster if changed
                        if (userData.cluster !== currentUser.cluster) {
                            userData.cluster = currentUser.cluster;
                            await saveMUSData(currentUser.email, userData);
                        }
                    }

                    await showEmployeeDashboard();
                } catch (error) {
                    console.error('Verify code error:', error);
                    alert('Fejl ved login. Pr√∏v igen.');
                }
            } else {
                alert('Forkert kode. Pr√∏v igen.');
            }
        }

        async function leaderLogin() {
            const username = document.getElementById('leaderUsername').value.trim();
            const password = document.getElementById('leaderPassword').value;

            try {
                const passwords = await getLeaderPasswords();

                if (passwords[username] && passwords[username] === password) {
                    isLeader = true;
                    currentLeader = username;
                    selectedLeaderCluster = null;
                    await showLeaderDashboard();
                } else {
                    alert('Forkert brugernavn eller adgangskode');
                }
            } catch (error) {
                console.error('Leader login error:', error);
                alert('Fejl ved login. Pr√∏v igen.');
            }
        }

        function logout() {
            currentUser = null;
            currentCode = null;
            isLeader = false;
            currentLeader = null;
            cachedTimeSlots = {};
            cachedQuestions = null;
            document.getElementById('employeeEmail').value = '';
            document.getElementById('leaderUsername').value = '';
            document.getElementById('leaderPassword').value = '';
            document.getElementById('codeInput').value = '';
            showScreen('loginScreen');
        }

        function goToLogin() {
            document.getElementById('codeInput').value = '';
            showScreen('loginScreen');
        }

        // Send code via email using EmailJS
        async function sendCodeByEmail() {
            if (!currentUser || !currentCode) {
                alert('Der opstod en fejl. Pr√∏v at logge ind igen.');
                return;
            }

            try {
                const templateParams = {
                    to_email: currentUser.email,
                    user_name: currentUser.name,
                    passcode: currentCode,
                    time: '1 time'
                };

                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
                
                alert(`‚úÖ Kode sendt til ${currentUser.email}!\n\nTjek din indbakke og indtast koden ovenfor.`);
            } catch (error) {
                console.error('Email send error:', error);
                alert('‚ùå Kunne ikke sende email. Pr√∏v igen.');
            }
        }

        // Resend code via email
        async function resendCodeByEmail() {
            if (!currentUser || !currentCode) {
                alert('Der opstod en fejl. Pr√∏v at logge ind igen.');
                goToLogin();
                return;
            }

            try {
                const btn = event.target;
                btn.disabled = true;
                btn.textContent = 'Sender...';

                const templateParams = {
                    to_email: currentUser.email,
                    user_name: currentUser.name,
                    passcode: currentCode,
                    time: '1 time'
                };

                await emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, templateParams);
                
                alert(`‚úÖ Kode sendt igen til ${currentUser.email}!`);
                
                btn.disabled = false;
                btn.textContent = 'üìß Send kode igen';
            } catch (error) {
                console.error('Email resend error:', error);
                alert('‚ùå Kunne ikke sende email. Pr√∏v igen.');
                
                const btn = event.target;
                btn.disabled = false;
                btn.textContent = 'üìß Send kode igen';
            }
        }

        // Screen navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // Employee Dashboard
        async function showEmployeeDashboard() {
            document.getElementById('employeeName').textContent = currentUser.name;
            await renderQuestionnaire();
            await loadBookingInfo();
            showScreen('employeeDashboard');
        }

        function showEmployeeTab(tab) {
            document.querySelectorAll('#employeeDashboard .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('bookingTab').style.display = tab === 'booking' ? 'block' : 'none';
            document.getElementById('questionnaireTab').style.display = tab === 'questionnaire' ? 'block' : 'none';
        }

        async function loadBookingInfo() {
            try {
                const userData = await getMUSData(currentUser.email);
                
                if (userData && userData.booking) {
                    document.getElementById('bookingTab').innerHTML = `
                        <h3>Din MUS-samtale er booket</h3>
                        <div class="alert alert-success">
                            <strong>‚úÖ Booket!</strong><br>
                            Leder: ${userData.booking.leader}<br>
                            Dato og tid: ${new Date(userData.booking.datetime).toLocaleString('da-DK')}<br>
                            ${userData.booking.notes ? 'Bem√¶rkninger: ' + userData.booking.notes : ''}
                        </div>
                        <p style="color: #666;">Hvis du har brug for at √¶ndre din booking, kontakt venligst din leder direkte.</p>
                    `;
                }
            } catch (error) {
                console.error('Load booking info error:', error);
            }
        }

        async function loadAvailableTimes() {
            const leader = document.getElementById('bookingLeader').value;
            
            if (!leader) {
                document.getElementById('availableTimesContainer').style.display = 'none';
                return;
            }

            try {
                const timeSlots = await getTimeSlots(leader);
                const availableSlots = timeSlots.filter(slot => !slot.bookedBy);

                const select = document.getElementById('bookingTimeSlot');
                select.innerHTML = '<option value="">-- V√¶lg tid --</option>';

                if (availableSlots.length === 0) {
                    select.innerHTML = '<option value="">Ingen ledige tider tilg√¶ngelige</option>';
                    document.getElementById('availableTimesContainer').style.display = 'block';
                    return;
                }

                availableSlots.forEach(slot => {
                    const date = new Date(slot.datetime);
                    const option = document.createElement('option');
                    option.value = slot.id;
                    option.textContent = date.toLocaleString('da-DK', {
                        weekday: 'long',
                        year: 'numeric',
                        month: 'long',
                        day: 'numeric',
                        hour: '2-digit',
                        minute: '2-digit'
                    });
                    select.appendChild(option);
                });

                document.getElementById('availableTimesContainer').style.display = 'block';
            } catch (error) {
                console.error('Load available times error:', error);
                alert('Fejl ved indl√¶sning af ledige tider');
            }
        }

        async function bookMUS() {
            const leader = document.getElementById('bookingLeader').value;
            const timeSlotId = document.getElementById('bookingTimeSlot').value;
            const notes = document.getElementById('musNotes').value;

            if (!leader || !timeSlotId) {
                alert('V√¶lg venligst b√•de leder og tid');
                return;
            }

            try {
                const timeSlots = await getTimeSlots(leader);
                const slot = timeSlots.find(s => s.id === timeSlotId);

                if (!slot || slot.bookedBy) {
                    alert('Denne tid er ikke l√¶ngere tilg√¶ngelig');
                    await loadAvailableTimes();
                    return;
                }

                // Mark slot as booked
                await updateTimeSlot(leader, timeSlotId, {
                    bookedBy: currentUser.email,
                    bookedByName: currentUser.name
                });

                // Save booking
                const booking = {
                    leader: leader,
                    leaderEmail: LEADER_EMAILS[leader],
                    datetime: slot.datetime,
                    notes: notes,
                    bookedAt: new Date().toISOString()
                };

                const userData = await getMUSData(currentUser.email);
                userData.booking = booking;
                await saveMUSData(currentUser.email, userData);

                // Show success message BEFORE opening Outlook
                alert(`‚úÖ MUS-booking gemt!\n\nLeder: ${leader}\nTid: ${new Date(slot.datetime).toLocaleString('da-DK')}\n\nOutlook √•bner nu i en ny fane s√• du kan sende m√∏de-invitationen.`);
                
                // Open Outlook (this might trigger pop-up blocker but booking is already saved)
                try {
                    openOutlookWebMeeting(slot.datetime, leader, LEADER_EMAILS[leader], notes);
                } catch (outlookError) {
                    console.log('Outlook open error (non-critical):', outlookError);
                }
                
                await loadBookingInfo();
                showEmployeeTab('booking');
            } catch (error) {
                console.error('Book MUS error:', error);
                alert('‚ùå Fejl ved booking. Bookingen blev ikke gemt. Pr√∏v igen.');
            }
        }

        function openOutlookWebMeeting(datetime, leaderName, leaderEmail, notes) {
            const date = new Date(datetime);
            const startISO = date.toISOString();
            const endDate = new Date(date.getTime() + 60 * 60 * 1000);
            const endISO = endDate.toISOString();
            
            const body = `MUS-samtale med ${currentUser.name}

Team: ${currentUser.cluster}
${notes ? 'Bem√¶rkninger: ' + notes : ''}`;
            
            const outlookWebUrl = `https://outlook.office.com/calendar/0/deeplink/compose?subject=${encodeURIComponent('MUS-samtale: ' + currentUser.name)}&body=${encodeURIComponent(body)}&to=${encodeURIComponent(leaderEmail)}&location=${encodeURIComponent('Bost√∏tten Viborg')}&startdt=${encodeURIComponent(startISO)}&enddt=${encodeURIComponent(endISO)}&path=/calendar/action/compose&rru=addevent`;
            
            window.open(outlookWebUrl, '_blank');
        }

        // Questionnaire rendering
        async function renderQuestionnaire() {
            try {
                const userData = await getMUSData(currentUser.email);
                const questions = userData.answers;
                
                let html = '<h3>Udfyld dit MUS-sp√∏rgeskema</h3>';
                html += '<p style="margin-bottom: 30px; color: #666;">Udfyld sp√∏rgeskemaet som forberedelse til din MUS-samtale. Dine svar gemmes automatisk.</p>';

                questions.forEach((section) => {
                    html += `<div class="question-section">`;
                    html += `<h3>${section.section}</h3>`;

                    section.questions.forEach((q, qIndex) => {
                        html += `<div class="question">`;
                        html += `<label class="question-label">${qIndex + 1}. ${q.text}</label>`;

                        if (q.type === 'textarea') {
                            html += `<textarea id="answer_${q.id}" onblur="saveAnswer('${q.id}')">${q.answer || ''}</textarea>`;
                        } else if (q.type === 'scale') {
                            const options = [
                                'I meget h√∏j grad',
                                'I h√∏j grad',
                                'I nogen grad',
                                'I mindre grad',
                                'Slet ikke'
                            ];
                            
                            html += `<div class="radio-group">`;
                            options.forEach(opt => {
                                const checked = q.answer === opt ? 'checked' : '';
                                html += `
                                    <div class="radio-option">
                                        <input type="radio" name="scale_${q.id}" value="${opt}" ${checked} onchange="saveAnswer('${q.id}')">
                                        <label>${opt}</label>
                                    </div>
                                `;
                            });
                            html += `</div>`;
                            html += `<label style="margin-top: 15px;">Uddyb gerne:</label>`;
                            html += `<textarea id="followup_${q.id}" onblur="saveFollowup('${q.id}')" style="min-height: 80px;">${q.followup || ''}</textarea>`;
                        }

                        html += `</div>`;
                    });

                    html += `</div>`;
                });

                document.getElementById('questionnaireForm').innerHTML = html;
            } catch (error) {
                console.error('Render questionnaire error:', error);
            }
        }

        async function saveAnswer(questionId) {
            try {
                const userData = await getMUSData(currentUser.email);
                
                for (let section of userData.answers) {
                    for (let q of section.questions) {
                        if (q.id === questionId) {
                            if (q.type === 'textarea') {
                                q.answer = document.getElementById(`answer_${questionId}`).value;
                            } else if (q.type === 'scale') {
                                const selected = document.querySelector(`input[name="scale_${questionId}"]:checked`);
                                q.answer = selected ? selected.value : '';
                            }
                            break;
                        }
                    }
                }

                await saveMUSData(currentUser.email, userData);
            } catch (error) {
                console.error('Save answer error:', error);
            }
        }

        async function saveFollowup(questionId) {
            try {
                const userData = await getMUSData(currentUser.email);
                
                for (let section of userData.answers) {
                    for (let q of section.questions) {
                        if (q.id === questionId) {
                            q.followup = document.getElementById(`followup_${questionId}`).value;
                            break;
                        }
                    }
                }

                await saveMUSData(currentUser.email, userData);
            } catch (error) {
                console.error('Save followup error:', error);
            }
        }

        // Leader Dashboard
        async function showLeaderDashboard() {
            document.getElementById('leaderNameDisplay').textContent = currentLeader;
            document.getElementById('leaderClusterSelect').value = selectedLeaderCluster || '';
            await renderTimeSlots();
            await renderEmployeesList();
            await renderQuestionsEditor();
            showScreen('leaderDashboard');
        }

        function showLeaderTab(tab) {
            document.querySelectorAll('#leaderDashboard .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('timeslotsTab').style.display = tab === 'timeslots' ? 'block' : 'none';
            document.getElementById('employeesTab').style.display = tab === 'employees' ? 'block' : 'none';
            document.getElementById('questionsTab').style.display = tab === 'questions' ? 'block' : 'none';
            document.getElementById('settingsTab').style.display = tab === 'settings' ? 'block' : 'none';
        }

        // Time Slots Management
        async function addTimeSlot() {
            const datetimeInput = document.getElementById('newTimeSlot').value;
            
            if (!datetimeInput) {
                alert('V√¶lg venligst en dato og tidspunkt');
                return;
            }

            try {
                const datetime = new Date(datetimeInput).toISOString();
                await addTimeSlotToDB(currentLeader, datetime);
                
                // Open Outlook to add to leader's calendar
                openOutlookForLeaderTimeSlot(datetime);
                
                document.getElementById('newTimeSlot').value = '';
                await renderTimeSlots();
                
                alert('‚úÖ Tid tilf√∏jet!\n\nOutlook √•bner nu s√• du kan tilf√∏je tiden til din kalender.');
            } catch (error) {
                console.error('Add time slot error:', error);
                alert('Fejl ved tilf√∏jelse af tid');
            }
        }

        function openOutlookForLeaderTimeSlot(datetime) {
            const date = new Date(datetime);
            const startISO = date.toISOString();
            const endDate = new Date(date.getTime() + 60 * 60 * 1000); // 1 hour
            const endISO = endDate.toISOString();
            
            const subject = 'MUS-samtale (LEDIG TID)';
            const body = `Ledig tid til MUS-samtale.

Denne tid er tilg√¶ngelig for medarbejdere at booke.

N√•r en medarbejder booker denne tid, f√•r du en m√∏de-invitation fra dem.`;
            
            const outlookWebUrl = `https://outlook.office.com/calendar/0/deeplink/compose?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(body)}&location=${encodeURIComponent('Bost√∏tten Viborg')}&startdt=${encodeURIComponent(startISO)}&enddt=${encodeURIComponent(endISO)}&path=/calendar/action/compose&rru=addevent`;
            
            window.open(outlookWebUrl, '_blank');
        }

        async function deleteTimeSlot(slotId) {
            if (!confirm('Er du sikker p√• at du vil slette denne tid?')) {
                return;
            }

            try {
                const timeSlots = await getTimeSlots(currentLeader);
                const slot = timeSlots.find(s => s.id === slotId);

                if (slot && slot.bookedBy) {
                    if (!confirm('Denne tid er allerede booket af ' + slot.bookedByName + '. Vil du stadig slette den?')) {
                        return;
                    }

                    // Remove booking from employee data
                    const userData = await getMUSData(slot.bookedBy);
                    if (userData && userData.booking) {
                        userData.booking = null;
                        await saveMUSData(slot.bookedBy, userData);
                    }
                }

                await deleteTimeSlotFromDB(currentLeader, slotId);
                await renderTimeSlots();
                
                alert('‚úÖ Tid slettet!');
            } catch (error) {
                console.error('Delete time slot error:', error);
                alert('Fejl ved sletning af tid');
            }
        }

        async function renderTimeSlots() {
            try {
                const timeSlots = await getTimeSlots(currentLeader);

                let html = '';

                if (timeSlots.length === 0) {
                    html = '<p style="color: #666; padding: 20px; text-align: center;">Ingen tider oprettet endnu. Tilf√∏j en tid ovenfor.</p>';
                } else {
                    timeSlots.forEach(slot => {
                        const date = new Date(slot.datetime);
                        const isBooked = !!slot.bookedBy;
                        
                        html += `
                            <div class="time-slot-card ${isBooked ? 'booked' : ''}">
                                <div class="time-slot-info">
                                    <strong>${date.toLocaleString('da-DK', {
                                        weekday: 'long',
                                        year: 'numeric',
                                        month: 'long',
                                        day: 'numeric',
                                        hour: '2-digit',
                                        minute: '2-digit'
                                    })}</strong>
                                    ${isBooked ? `<br><span style="color: #155724;">‚úÖ Booket af: ${slot.bookedByName}</span>` : '<br><span style="color: #856404;">‚è≥ Ledig</span>'}
                                </div>
                                <div class="time-slot-actions">
                                    <button class="btn btn-danger btn-small" onclick="deleteTimeSlot('${slot.id}')">Slet</button>
                                </div>
                            </div>
                        `;
                    });
                }

                document.getElementById('timeSlotsList').innerHTML = html;
            } catch (error) {
                console.error('Render time slots error:', error);
            }
        }

        // Employee Management
        function changeLeaderCluster() {
            selectedLeaderCluster = document.getElementById('leaderClusterSelect').value;
            renderEmployeesList();
        }

        async function renderEmployeesList() {
            try {
                const allData = await getAllMUSData();
                const emails = Object.keys(allData);

                let html = '';

                if (!selectedLeaderCluster) {
                    html = '<p style="color: #666; text-align: center; padding: 40px;">üëÜ V√¶lg venligst en team ovenfor for at se medarbejdere</p>';
                } else {
                    const filteredEmails = emails.filter(email => {
                        const data = allData[email];
                        return data.cluster === selectedLeaderCluster && 
                               data.booking && 
                               data.booking.leader === currentLeader;
                    });

                    if (filteredEmails.length === 0) {
                        html = `<p style="color: #666; text-align: center; padding: 40px;">Ingen medarbejdere i Team ${selectedLeaderCluster} har booket MUS med dig endnu.</p>`;
                    } else {
                        filteredEmails.forEach(email => {
                            const data = allData[email];
                            const hasAnswers = data.answers.some(s => s.questions.some(q => q.answer));

                            html += `
                                <div class="employee-card" onclick="showEmployeeDetail('${email}')">
                                    <h4>${data.name}</h4>
                                    <p style="color: #666; margin-bottom: 10px;">${email} ‚Ä¢ Team ${data.cluster}</p>
                                    <div>
                                        <span class="status status-completed">üìÖ Booket: ${new Date(data.booking.datetime).toLocaleDateString('da-DK')}</span>
                                        ${hasAnswers ?
                                            `<span class="status status-completed" style="margin-left: 10px;">‚úÖ Sp√∏rgeskema p√•begyndt</span>` :
                                            `<span class="status status-pending" style="margin-left: 10px;">‚è≥ Ikke udfyldt</span>`
                                        }
                                    </div>
                                </div>
                            `;
                        });
                    }
                }

                document.getElementById('employeesList').innerHTML = html;
            } catch (error) {
                console.error('Render employees list error:', error);
            }
        }

        async function showEmployeeDetail(email) {
            try {
                currentEmployeeDetail = email;
                const data = await getMUSData(email);

                document.getElementById('detailEmployeeName').textContent = `${data.name} - Team ${data.cluster}`;

                let bookingHtml = '';
                if (data.booking) {
                    bookingHtml = `
                        <strong>üìÖ MUS-booking:</strong><br>
                        Dato og tid: ${new Date(data.booking.datetime).toLocaleString('da-DK')}<br>
                        ${data.booking.notes ? `Bem√¶rkninger: ${data.booking.notes}` : ''}
                    `;
                }
                document.getElementById('detailBookingInfo').innerHTML = bookingHtml;

                let answersHtml = '<h3>Medarbejderens svar og dine kommentarer</h3>';
                
                data.answers.forEach((section) => {
                    answersHtml += `<div class="question-section">`;
                    answersHtml += `<h3>${section.section}</h3>`;

                    section.questions.forEach((q, qIndex) => {
                        answersHtml += `<div class="question">`;
                        answersHtml += `<label class="question-label">${qIndex + 1}. ${q.text}</label>`;

                        if (q.type === 'textarea') {
                            const answer = q.answer || '<em style="color: #999;">Ikke besvaret endnu</em>';
                            answersHtml += `<div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #e0e0e0; margin-bottom: 15px;">
                                <strong>Medarbejderens svar:</strong><br>${answer}
                            </div>`;
                            
                            answersHtml += `<label style="color: #667eea; font-weight: 600; margin-top: 10px;">Dine kommentarer / Aftaler:</label>`;
                            answersHtml += `<textarea 
                                id="leader_comment_${q.id}" 
                                onblur="saveLeaderComment('${q.id}')"
                                style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px;"
                                placeholder="Skriv dine kommentarer eller aftaler her..."
                            >${q.leaderComment || ''}</textarea>`;
                            
                        } else if (q.type === 'scale') {
                            const answer = q.answer || '<em style="color: #999;">Ikke besvaret</em>';
                            answersHtml += `<div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #e0e0e0; margin-bottom: 10px;">
                                <strong>Vurdering:</strong> ${answer}
                            </div>`;
                            
                            if (q.followup) {
                                answersHtml += `<div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #e0e0e0; margin-bottom: 15px;">
                                    <strong>Medarbejderens uddybning:</strong><br>${q.followup}
                                </div>`;
                            }
                            
                            answersHtml += `<label style="color: #667eea; font-weight: 600; margin-top: 10px;">Dine kommentarer / Aftaler:</label>`;
                            answersHtml += `<textarea 
                                id="leader_comment_${q.id}" 
                                onblur="saveLeaderComment('${q.id}')"
                                style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #667eea; border-radius: 8px; font-size: 14px;"
                                placeholder="Skriv dine kommentarer eller aftaler her..."
                            >${q.leaderComment || ''}</textarea>`;
                        }

                        answersHtml += `</div>`;
                    });

                    answersHtml += `</div>`;
                });

                document.getElementById('detailAnswers').innerHTML = answersHtml;
                showScreen('employeeDetailScreen');
            } catch (error) {
                console.error('Show employee detail error:', error);
                alert('Fejl ved indl√¶sning af medarbejder-data');
            }
        }

        function backToLeaderDashboard() {
            currentEmployeeDetail = null;
            showLeaderDashboard();
        }

        async function saveLeaderComment(questionId) {
            try {
                const email = currentEmployeeDetail;
                const userData = await getMUSData(email);
                
                for (let section of userData.answers) {
                    for (let q of section.questions) {
                        if (q.id === questionId) {
                            const commentField = document.getElementById(`leader_comment_${questionId}`);
                            if (commentField) {
                                q.leaderComment = commentField.value;
                            }
                            break;
                        }
                    }
                }

                await saveMUSData(email, userData);
            } catch (error) {
                console.error('Save leader comment error:', error);
            }
        }

        // Questions Editor
        async function renderQuestionsEditor() {
            try {
                const questions = await getQuestions();
                
                let html = '';

                questions.forEach((section) => {
                    html += `<div class="question-section">`;
                    html += `<h3>${section.section}</h3>`;

                    section.questions.forEach((q, qIndex) => {
                        html += `<div style="background: #fafafa; border: 1px solid #dee2e6; border-radius: 8px; padding: 15px; margin-bottom: 15px;">`;
                        html += `<label><strong>Sp√∏rgsm√•l ${qIndex + 1}:</strong></label>`;
                        html += `<textarea id="edit_${q.id}" style="min-height: 60px;">${q.text}</textarea>`;
                        html += `<p style="color: #666; font-size: 0.9em; margin-top: 5px;">Type: ${q.type === 'textarea' ? '√Öben tekst' : 'Skala + uddybning'}</p>`;
                        html += `</div>`;
                    });

                    html += `</div>`;
                });

                document.getElementById('questionsEditor').innerHTML = html;
            } catch (error) {
                console.error('Render questions editor error:', error);
            }
        }

        async function saveQuestionsFromEditor() {
            const btn = event.target;
            const originalText = btn.textContent;
            
            try {
                btn.disabled = true;
                btn.textContent = 'Gemmer...';
                
                const questions = await getQuestions();

                questions.forEach((section) => {
                    section.questions.forEach((q) => {
                        const textarea = document.getElementById(`edit_${q.id}`);
                        if (textarea) {
                            q.text = textarea.value;
                        }
                    });
                });

                await saveQuestions(questions);
                
                btn.disabled = false;
                btn.textContent = originalText;
                
                alert('‚úÖ Sp√∏rgsm√•l gemt! Nye medarbejdere vil f√• de opdaterede sp√∏rgsm√•l.');
            } catch (error) {
                console.error('Save questions error:', error);
                
                btn.disabled = false;
                btn.textContent = originalText;
                
                alert('‚ùå Fejl ved gemning af sp√∏rgsm√•l. Pr√∏v igen.');
            }
        }

        // Password Management
        async function changePassword() {
            const currentPassword = document.getElementById('currentPassword').value;
            const newPassword = document.getElementById('newPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;

            if (!currentPassword || !newPassword || !confirmPassword) {
                alert('Udfyld venligst alle felter');
                return;
            }

            try {
                const passwords = await getLeaderPasswords();

                if (passwords[currentLeader] !== currentPassword) {
                    alert('Nuv√¶rende adgangskode er forkert');
                    return;
                }

                if (newPassword !== confirmPassword) {
                    alert('De nye adgangskoder matcher ikke');
                    return;
                }

                if (newPassword.length < 4) {
                    alert('Adgangskoden skal v√¶re mindst 4 tegn');
                    return;
                }

                passwords[currentLeader] = newPassword;
                await saveLeaderPasswords(passwords);

                document.getElementById('currentPassword').value = '';
                document.getElementById('newPassword').value = '';
                document.getElementById('confirmPassword').value = '';

                alert('‚úÖ Adgangskode √¶ndret!');
            } catch (error) {
                console.error('Change password error:', error);
                alert('Fejl ved √¶ndring af adgangskode');
            }
        }

        // Export to PDF
        async function exportToPDF() {
            if (typeof window.jspdf === 'undefined') {
                alert('‚ö†Ô∏è PDF-biblioteket er ikke loaded endnu.\n\nVent et √∏jeblik og pr√∏v igen.');
                return;
            }

            const email = currentEmployeeDetail;
            
            try {
                const data = await getMUSData(email);

                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPos = 20;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                const maxWidth = 170;
                
                function addText(text, fontSize = 12, isBold = false, addSpace = 5) {
                    if (yPos > pageHeight - 20) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(fontSize);
                    doc.setFont(undefined, isBold ? 'bold' : 'normal');
                    
                    const lines = doc.splitTextToSize(text, maxWidth);
                    lines.forEach(line => {
                        if (yPos > pageHeight - 20) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(line, margin, yPos);
                        yPos += fontSize * 0.5;
                    });
                    yPos += addSpace;
                }
                
                addText('Medarbejderudviklingssamtale (MUS)', 18, true, 10);
                addText(`Medarbejder: ${data.name}`, 12, false, 3);
                addText(`Team: ${data.cluster}`, 12, false, 3);
                addText(`Dato: ${new Date().toLocaleDateString('da-DK')}`, 12, false, 10);
                
                if (data.booking) {
                    addText(`MUS-samtale booket med ${data.booking.leader}: ${new Date(data.booking.datetime).toLocaleString('da-DK')}`, 11, false, 10);
                }
                
                data.answers.forEach((section) => {
                    addText(section.section, 14, true, 8);
                    
                    section.questions.forEach((q, qIdx) => {
                        addText(`${qIdx + 1}. ${q.text}`, 11, true, 5);
                        
                        if (q.type === 'textarea') {
                            addText('Medarbejderens svar:', 10, true, 3);
                            addText(q.answer || 'Ikke besvaret', 10, false, 5);
                            
                            if (q.leaderComment) {
                                addText('Lederens kommentarer / Aftaler:', 10, true, 3);
                                addText(q.leaderComment, 10, false, 8);
                            } else {
                                yPos += 3;
                            }
                            
                        } else if (q.type === 'scale') {
                            addText(`Vurdering: ${q.answer || 'Ikke besvaret'}`, 10, false, 3);
                            
                            if (q.followup) {
                                addText('Medarbejderens uddybning:', 10, true, 3);
                                addText(q.followup, 10, false, 5);
                            }
                            
                            if (q.leaderComment) {
                                addText('Lederens kommentarer / Aftaler:', 10, true, 3);
                                addText(q.leaderComment, 10, false, 8);
                            } else {
                                yPos += 3;
                            }
                        }
                    });
                });
                
                yPos += 15;
                addText('Underskrifter', 14, true, 10);
                addText('Medarbejder:', 11, true, 5);
                addText('_________________________________________', 11, false, 3);
                addText(`${data.name}`, 10, false, 3);
                addText(`Dato: _____________________`, 10, false, 10);
                addText('Leder:', 11, true, 5);
                addText('_________________________________________', 11, false, 3);
                addText(data.booking && data.booking.leader ? data.booking.leader : '___________________', 10, false, 3);
                addText(`Dato: _____________________`, 10, false, 10);
                
                doc.save(`MUS_${data.name}_${new Date().toISOString().split('T')[0]}.pdf`);
                
                setTimeout(async () => {
                    if (confirm(`PDF-dokument gemt!\n\nVil du slette ${data.name}'s data fra systemet?\n\n(Data skal slettes n√•r MUS er afholdt og dokumentet er lagt i P-sagen)`)) {
                        const dataRef = window.firebaseRef(window.firebaseDB, `musData/${email.replace(/\./g, '_')}`);
                        await window.firebaseRemove(dataRef);
                        
                        alert('‚úÖ Data slettet fra systemet');
                        backToLeaderDashboard();
                    }
                }, 500);
                
            } catch (error) {
                console.error('PDF export error:', error);
                alert('‚ùå Der opstod en fejl ved eksport til PDF.\n\nFejl: ' + error.message);
            }
        }

        // Make saveQuestions available globally
        window.saveQuestions = saveQuestionsFromEditor;
    </script>
</body>
</html>
