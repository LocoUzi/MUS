<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>LUS System - Handicap</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a4d3e 0%, #2d6b56 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #1a4d3e;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input[type="email"],
        input[type="text"],
        input[type="password"],
        input[type="date"],
        input[type="time"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #1a4d3e;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            background: #1a4d3e;
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: #143d31;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(26, 77, 62, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .code-display {
            background: #e8f5f1;
            border: 2px dashed #2d6b56;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .code-display .code {
            font-size: 2em;
            font-weight: bold;
            color: #1a4d3e;
            letter-spacing: 5px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #e8f5f1;
            color: #0c5460;
            border: 1px solid #2d6b56;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .question-section {
            background: #fafafa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
            border-left: 4px solid #1a4d3e;
        }

        .question-section h3 {
            color: #1a4d3e;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #2d6b56;
        }

        .question {
            margin-bottom: 25px;
        }

        .question-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: block;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .radio-option input[type="radio"] {
            width: auto;
        }

        .employee-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .employee-card:hover {
            border-color: #1a4d3e;
            box-shadow: 0 5px 15px rgba(26, 77, 62, 0.2);
        }

        .employee-card h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .employee-card .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #1a4d3e;
            border-bottom-color: #1a4d3e;
        }

        .tab:hover {
            color: #1a4d3e;
        }

        .question-editor {
            background: #fafafa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .question-editor textarea {
            min-height: 60px;
        }

        .navigation-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .navigation-buttons button {
            flex: 1;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .radio-group {
                flex-direction: column;
            }

            .navigation-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üèõÔ∏è LUS System</h1>
            <p>Handicap - Lederudviklingssamtaler</p>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="screen active">
            <div class="form-group">
                <label for="loginType">V√¶lg logintype:</label>
                <select id="loginType" onchange="toggleLoginType()">
                    <option value="employee">Teamleder</option>
                    <option value="leader">Ledelse (Lilli Ane)</option>
                </select>
            </div>

            <div id="employeeLogin">
                <div class="form-group">
                    <label for="employeeEmail">Din arbejds-email:</label>
                    <input type="email" id="employeeEmail" placeholder="din.email@viborg.dk">
                </div>
                <button class="btn" onclick="sendCode()">Send engangskode</button>
            </div>

            <div id="leaderLogin" style="display: none;">
                <div class="form-group">
                    <label for="leaderPassword">Leder-adgangskode:</label>
                    <input type="password" id="leaderPassword" placeholder="Indtast adgangskode">
                </div>
                <button class="btn" onclick="leaderLogin()">Log ind som leder</button>
            </div>
        </div>

        <!-- Code Verification Screen -->
        <div id="codeScreen" class="screen">
            <div class="alert alert-info">
                <strong>üìß Engangskode sendt!</strong><br>
                Din engangskode er vist nedenfor. I fremtiden vil den blive sendt til din email.
            </div>
            
            <div class="code-display">
                <p>Din engangskode:</p>
                <div class="code" id="displayedCode"></div>
            </div>

            <div class="form-group">
                <label for="codeInput">Indtast engangskode:</label>
                <input type="text" id="codeInput" placeholder="Indtast 4-cifret kode" maxlength="4">
            </div>

            <button class="btn" onclick="verifyCode()">Verificer kode</button>
            <button class="btn btn-secondary" onclick="goToLogin()">Tilbage</button>
        </div>

        <!-- Employee Dashboard -->
        <div id="employeeDashboard" class="screen">
            <div class="alert alert-success">
                Velkommen, <span id="employeeName"></span>!
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showEmployeeTab('booking')">üìÖ Book LUS</button>
                <button class="tab" onclick="showEmployeeTab('questionnaire')">üìù Sp√∏rgeskema</button>
            </div>

            <!-- Booking Tab -->
            <div id="bookingTab" class="tab-content">
                <h3>Book din LUS-samtale</h3>
                <p style="margin-bottom: 20px; color: #666;">
                    Tjek Lilli Anes kalender i Outlook og v√¶lg en ledig tid nedenfor.
                </p>

                <div class="form-group">
                    <label for="musDate">√ònsket dato:</label>
                    <input type="date" id="musDate">
                </div>

                <div class="form-group">
                    <label for="musTime">√ònsket tidspunkt:</label>
                    <input type="time" id="musTime">
                </div>

                <div class="form-group">
                    <label for="musNotes">Evt. bem√¶rkninger:</label>
                    <textarea id="musNotes" placeholder="F.eks. 'Jeg har allerede tjekket at du er ledig denne dag'"></textarea>
                </div>

                <button class="btn" onclick="bookMUS()">Book LUS og √•bn Outlook</button>
            </div>

            <!-- Questionnaire Tab -->
            <div id="questionnaireTab" class="tab-content" style="display: none;">
                <div id="questionnaireForm"></div>
            </div>

            <button class="btn btn-secondary" onclick="logout()" style="margin-top: 30px;">Log ud</button>
        </div>

        <!-- Leader Dashboard -->
        <div id="leaderDashboard" class="screen">
            <div class="alert alert-success">
                Velkommen til leder-panelet, Lilli Ane!
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showLeaderTab('employees')">üë• Teamledere</button>
                <button class="tab" onclick="showLeaderTab('questions')">‚öôÔ∏è Rediger sp√∏rgsm√•l</button>
            </div>

            <!-- Employees Tab -->
            <div id="employeesTab" class="tab-content">
                <h3>Alle teamlederes LUS</h3>
                <div id="employeesList"></div>
            </div>

            <!-- Questions Tab -->
            <div id="questionsTab" class="tab-content" style="display: none;">
                <h3>Rediger standard LUS-sp√∏rgsm√•l</h3>
                <p style="margin-bottom: 20px; color: #666;">
                    Disse sp√∏rgsm√•l er f√¶lles for alle teamledere. Du kan redigere dem her.
                </p>
                <div id="questionsEditor"></div>
                <button class="btn btn-success" onclick="saveQuestions()">Gem √¶ndringer</button>
            </div>

            <button class="btn btn-secondary" onclick="logout()" style="margin-top: 30px;">Log ud</button>
        </div>

        <!-- Employee Detail View -->
        <div id="employeeDetailScreen" class="screen">
            <button class="btn btn-secondary" onclick="backToLeaderDashboard()" style="margin-bottom: 20px;">‚Üê Tilbage til oversigt</button>
            
            <h2 id="detailEmployeeName"></h2>
            <div id="detailBookingInfo" class="alert alert-info"></div>
            
            <div id="detailAnswers"></div>

            <div class="navigation-buttons">
                <button class="btn btn-success" onclick="exportToPDF()">üìÑ Gem som PDF-dokument</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script>
        // State management
        let currentUser = null;
        let currentCode = null;
        let isLeader = false;
        let currentEmployeeDetail = null;

        // Default leader password
        const LEADER_PASSWORD = "1305";

        // LUS-specific questions focused on leadership development
        const DEFAULT_QUESTIONS = [
            {
                section: "Opf√∏lgning siden sidst",
                questions: [
                    {
                        id: "q1",
                        text: "Hvordan er det g√•et med opf√∏lgning p√• aftaler om lederudvikling siden sidst?",
                        type: "textarea",
                        answer: ""
                    },
                    {
                        id: "q2",
                        text: "Hvilke ledelsesm√¶ssige succeser har du oplevet siden sidste LUS?",
                        type: "textarea",
                        answer: ""
                    },
                    {
                        id: "q3",
                        text: "Hvilke ledelsesm√¶ssige udfordringer har du m√∏dt, og hvordan har du h√•ndteret dem?",
                        type: "textarea",
                        answer: ""
                    }
                ]
            },
            {
                section: "Ledelseskompetencer og -stil",
                questions: [
                    {
                        id: "q4",
                        text: "Jeg har en klar forst√•else af min rolle som leder og mine ledelsesm√¶ssige ansvar",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q5",
                        text: "Jeg form√•r at skabe klare rammer og retning for mit team",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q6",
                        text: "Jeg er god til at motivere og engagere mine medarbejdere",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q7",
                        text: "Jeg h√•ndterer sv√¶re samtaler og konflikter konstruktivt",
                        type: "scale",
                        answer: "",
                        followup: ""
                    }
                ]
            },
            {
                section: "Medarbejderudvikling og trivsel",
                questions: [
                    {
                        id: "q8",
                        text: "Jeg prioriterer og gennemf√∏rer MUS/udviklingssamtaler med mine medarbejdere",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q9",
                        text: "Jeg arbejder aktivt med at udvikle mine medarbejderes kompetencer",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q10",
                        text: "Jeg har fokus p√• trivsel og arbejdsmilj√∏ i mit team",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q11",
                        text: "Hvordan arbejder du med at fastholde og udvikle dine medarbejdere?",
                        type: "textarea",
                        answer: ""
                    }
                ]
            },
            {
                section: "Strategisk ledelse og organisationsudvikling",
                questions: [
                    {
                        id: "q12",
                        text: "Jeg bidrager aktivt til organisationens strategiske udvikling",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q13",
                        text: "Jeg form√•r at oms√¶tte strategi til handling i mit team",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q14",
                        text: "Hvordan arbejder du med innovation og forandring i dit omr√•de?",
                        type: "textarea",
                        answer: ""
                    }
                ]
            },
            {
                section: "Samarbejde og netv√¶rk",
                questions: [
                    {
                        id: "q15",
                        text: "Jeg samarbejder konstruktivt med andre ledere i organisationen",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q16",
                        text: "Jeg f√•r den n√∏dvendige st√∏tte og sparring fra min leder",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q17",
                        text: "Hvilke udfordringer oplever du i samarbejdet med andre dele af organisationen?",
                        type: "textarea",
                        answer: ""
                    }
                ]
            },
            {
                section: "Ressourcer og balance",
                questions: [
                    {
                        id: "q18",
                        text: "Jeg har de n√∏dvendige ressourcer til at l√∏se mine ledelses opgaver",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q19",
                        text: "Jeg har en god balance mellem arbejde og privatliv",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q20",
                        text: "Hvad har betydning for din fortsatte motivation og engagement som leder?",
                        type: "textarea",
                        answer: ""
                    }
                ]
            },
            {
                section: "Lederudvikling og m√•l",
                questions: [
                    {
                        id: "q21",
                        text: "Hvilke ledelseskompetencer √∏nsker du at udvikle det kommende √•r?",
                        type: "textarea",
                        answer: ""
                    },
                    {
                        id: "q22",
                        text: "Hvilke 1-2 ledelsesm√•l vil du fokusere p√• fremadrettet? Hvilke indsatser kr√¶ver de?",
                        type: "textarea",
                        answer: ""
                    }
                ]
            }
        ];

        // Initialize localStorage
        function initStorage() {
            if (!localStorage.getItem('lusDataHandicap')) {
                localStorage.setItem('lusDataHandicap', JSON.stringify({}));
            }
            if (!localStorage.getItem('lusQuestionsHandicap')) {
                localStorage.setItem('lusQuestionsHandicap', JSON.stringify(DEFAULT_QUESTIONS));
            }
        }

        // Get all LUS data
        function getAllMUSData() {
            return JSON.parse(localStorage.getItem('lusDataHandicap') || '{}');
        }

        // Save LUS data
        function saveMUSData(email, data) {
            const allData = getAllMUSData();
            allData[email] = data;
            localStorage.setItem('lusDataHandicap', JSON.stringify(allData));
        }

        // Get questions
        function getQuestions() {
            return JSON.parse(localStorage.getItem('lusQuestionsHandicap') || JSON.stringify(DEFAULT_QUESTIONS));
        }

        // Save questions
        function saveQuestionsToStorage(questions) {
            localStorage.setItem('lusQuestionsHandicap', JSON.stringify(questions));
        }

        // Login functions
        function toggleLoginType() {
            const type = document.getElementById('loginType').value;
            document.getElementById('employeeLogin').style.display = type === 'employee' ? 'block' : 'none';
            document.getElementById('leaderLogin').style.display = type === 'leader' ? 'block' : 'none';
        }

        function sendCode() {
            const email = document.getElementById('employeeEmail').value.trim();
            
            if (!email || !email.includes('@')) {
                alert('Indtast venligst en gyldig email-adresse');
                return;
            }

            // Check if user already exists and has a permanent code
            const allData = getAllMUSData();
            let permanentCode;
            
            if (allData[email] && allData[email].permanentCode) {
                // Use existing permanent code
                permanentCode = allData[email].permanentCode;
            } else {
                // Generate new permanent 4-digit code for first-time user
                permanentCode = Math.floor(1000 + Math.random() * 9000).toString();
                
                // Save the permanent code immediately
                if (!allData[email]) {
                    allData[email] = {
                        name: email.split('@')[0],
                        email: email,
                        permanentCode: permanentCode,
                        booking: null,
                        answers: getQuestions()
                    };
                } else {
                    allData[email].permanentCode = permanentCode;
                }
                saveMUSData(email, allData[email]);
            }

            currentCode = permanentCode;
            currentUser = { 
                email: email, 
                name: email.split('@')[0]
            };

            // Show code screen with message about permanent code
            const isFirstTime = !allData[email] || !allData[email].permanentCode;
            document.getElementById('displayedCode').textContent = currentCode;
            
            // Update message based on first time or returning user
            const codeMessage = document.querySelector('#codeScreen .alert');
            if (isFirstTime) {
                codeMessage.innerHTML = `
                    <strong>üìß Din personlige engangskode!</strong><br>
                    Dette er din <strong>faste kode</strong>. Gem den godt - du skal bruge den samme kode hver gang du logger ind.
                `;
            } else {
                codeMessage.innerHTML = `
                    <strong>üìß Velkommen tilbage!</strong><br>
                    Indtast din faste kode nedenfor. (Det er den samme kode som sidst)
                `;
            }
            
            showScreen('codeScreen');
        }

        function verifyCode() {
            const inputCode = document.getElementById('codeInput').value;

            if (inputCode === currentCode) {
                isLeader = false;
                
                // Initialize or update user data
                const allData = getAllMUSData();
                if (!allData[currentUser.email]) {
                    allData[currentUser.email] = {
                        name: currentUser.name,
                        email: currentUser.email,
                        permanentCode: currentCode,
                        booking: null,
                        answers: getQuestions()
                    };
                    saveMUSData(currentUser.email, allData[currentUser.email]);
                } else {
                    // Ensure permanent code is saved
                    if (!allData[currentUser.email].permanentCode) {
                        allData[currentUser.email].permanentCode = currentCode;
                    }
                    saveMUSData(currentUser.email, allData[currentUser.email]);
                }

                showEmployeeDashboard();
            } else {
                alert('Forkert kode. Pr√∏v igen.');
            }
        }

        function leaderLogin() {
            const password = document.getElementById('leaderPassword').value;

            if (password === LEADER_PASSWORD) {
                isLeader = true;
                showLeaderDashboard();
            } else {
                alert('Forkert adgangskode');
            }
        }

        function logout() {
            currentUser = null;
            currentCode = null;
            isLeader = false;
            document.getElementById('employeeEmail').value = '';
            document.getElementById('leaderPassword').value = '';
            document.getElementById('codeInput').value = '';
            showScreen('loginScreen');
        }

        function goToLogin() {
            document.getElementById('codeInput').value = '';
            showScreen('loginScreen');
        }

        // Screen navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // Employee Dashboard
        function showEmployeeDashboard() {
            document.getElementById('employeeName').textContent = currentUser.name;
            renderQuestionnaire();
            showScreen('employeeDashboard');
        }

        function showEmployeeTab(tab) {
            document.querySelectorAll('#employeeDashboard .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('bookingTab').style.display = tab === 'booking' ? 'block' : 'none';
            document.getElementById('questionnaireTab').style.display = tab === 'questionnaire' ? 'block' : 'none';
        }

        function bookMUS() {
            const date = document.getElementById('musDate').value;
            const time = document.getElementById('musTime').value;
            const notes = document.getElementById('musNotes').value;

            if (!date || !time) {
                alert('V√¶lg venligst b√•de dato og tidspunkt');
                return;
            }

            const leaderEmail = 'liu@viborg.dk';
            const leaderName = 'Lilli Ane';

            // Save booking info
            const booking = {
                leader: leaderName,
                leaderEmail: leaderEmail,
                date: date,
                time: time,
                notes: notes,
                bookedAt: new Date().toISOString()
            };

            const userData = getAllMUSData()[currentUser.email];
            userData.booking = booking;
            saveMUSData(currentUser.email, userData);

            // Open Outlook Web with meeting invitation
            openOutlookWebMeeting(date, time, leaderEmail, leaderName, notes);

            alert(`‚úÖ LUS-booking gemt!\n\nDato: ${date}\nTidspunkt: ${time}\nLeder: ${leaderName}\n\nOutlook √•bner nu i en ny fane s√• du kan sende m√∏de-invitationen til ${leaderName}.`);
            
            // Clear form
            document.getElementById('musDate').value = '';
            document.getElementById('musTime').value = '';
            document.getElementById('musNotes').value = '';
        }

        function openOutlookWebMeeting(date, time, leaderEmail, leaderName, notes) {
            // Format date and time for Outlook Web
            const [year, month, day] = date.split('-');
            const [hours, minutes] = time.split(':');
            
            // Create start date/time in ISO format
            const startDate = new Date(year, month - 1, day, hours, minutes);
            const startISO = startDate.toISOString();
            
            // Create end date/time (1 hour later)
            const endDate = new Date(startDate.getTime() + 60 * 60 * 1000);
            const endISO = endDate.toISOString();
            
            // Build meeting body/description
            const body = `LUS-samtale med ${currentUser.name}
${notes ? 'Bem√¶rkninger: ' + notes : ''}`;
            
            // Build Outlook Web URL
            const outlookWebUrl = `https://outlook.office.com/calendar/0/deeplink/compose?subject=${encodeURIComponent('LUS-samtale: ' + currentUser.name)}&body=${encodeURIComponent(body)}&to=${encodeURIComponent(leaderEmail)}&location=${encodeURIComponent('Handicap')}&startdt=${encodeURIComponent(startISO)}&enddt=${encodeURIComponent(endISO)}&path=/calendar/action/compose&rru=addevent`;
            
            // Open in new tab
            window.open(outlookWebUrl, '_blank');
        }

        // Questionnaire rendering
        function renderQuestionnaire() {
            const userData = getAllMUSData()[currentUser.email];
            const questions = userData.answers;
            
            let html = '<h3>Udfyld dit LUS-sp√∏rgeskema</h3>';
            html += '<p style="margin-bottom: 30px; color: #666;">Udfyld sp√∏rgeskemaet som forberedelse til din LUS-samtale. Dine svar gemmes automatisk.</p>';

            questions.forEach((section, sIndex) => {
                html += `<div class="question-section">`;
                html += `<h3>${section.section}</h3>`;

                section.questions.forEach((q, qIndex) => {
                    html += `<div class="question">`;
                    html += `<label class="question-label">${qIndex + 1}. ${q.text}</label>`;

                    if (q.type === 'textarea') {
                        html += `<textarea id="answer_${q.id}" onblur="saveAnswer('${q.id}')">${q.answer || ''}</textarea>`;
                    } else if (q.type === 'scale') {
                        const options = [
                            'I meget h√∏j grad',
                            'I h√∏j grad',
                            'I nogen grad',
                            'I mindre grad',
                            'Slet ikke'
                        ];
                        
                        html += `<div class="radio-group">`;
                        options.forEach(opt => {
                            const checked = q.answer === opt ? 'checked' : '';
                            html += `
                                <div class="radio-option">
                                    <input type="radio" name="scale_${q.id}" value="${opt}" ${checked} onchange="saveAnswer('${q.id}')">
                                    <label>${opt}</label>
                                </div>
                            `;
                        });
                        html += `</div>`;
                        html += `<label style="margin-top: 15px;">Uddyb gerne:</label>`;
                        html += `<textarea id="followup_${q.id}" onblur="saveFollowup('${q.id}')" style="min-height: 80px;">${q.followup || ''}</textarea>`;
                    }

                    html += `</div>`;
                });

                html += `</div>`;
            });

            document.getElementById('questionnaireForm').innerHTML = html;
        }

        function saveAnswer(questionId) {
            const userData = getAllMUSData()[currentUser.email];
            
            // Find the question
            for (let section of userData.answers) {
                for (let q of section.questions) {
                    if (q.id === questionId) {
                        if (q.type === 'textarea') {
                            q.answer = document.getElementById(`answer_${questionId}`).value;
                        } else if (q.type === 'scale') {
                            const selected = document.querySelector(`input[name="scale_${questionId}"]:checked`);
                            q.answer = selected ? selected.value : '';
                        }
                        break;
                    }
                }
            }

            saveMUSData(currentUser.email, userData);
        }

        function saveFollowup(questionId) {
            const userData = getAllMUSData()[currentUser.email];
            
            for (let section of userData.answers) {
                for (let q of section.questions) {
                    if (q.id === questionId) {
                        q.followup = document.getElementById(`followup_${questionId}`).value;
                        break;
                    }
                }
            }

            saveMUSData(currentUser.email, userData);
        }

        // Leader Dashboard
        function showLeaderDashboard() {
            renderEmployeesList();
            renderQuestionsEditor();
            showScreen('leaderDashboard');
        }

        function showLeaderTab(tab) {
            document.querySelectorAll('#leaderDashboard .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('employeesTab').style.display = tab === 'employees' ? 'block' : 'none';
            document.getElementById('questionsTab').style.display = tab === 'questions' ? 'block' : 'none';
        }

        function renderEmployeesList() {
            const allData = getAllMUSData();
            const emails = Object.keys(allData);

            let html = '';

            if (emails.length === 0) {
                html = '<p style="color: #666; text-align: center; padding: 40px;">Ingen teamledere har tilmeldt sig endnu.</p>';
            } else {
                emails.forEach(email => {
                    const data = allData[email];
                    const hasBooking = data.booking !== null;
                    const hasAnswers = data.answers.some(s => s.questions.some(q => q.answer));

                    html += `
                        <div class="employee-card" onclick="showEmployeeDetail('${email}')">
                            <h4>${data.name}</h4>
                            <p style="color: #666; margin-bottom: 10px;">${email}</p>
                            <div>
                                ${hasBooking ? 
                                    `<span class="status status-completed">üìÖ Booket: ${data.booking.date} kl. ${data.booking.time}</span>` :
                                    `<span class="status status-pending">‚è≥ Ikke booket</span>`
                                }
                                ${hasAnswers ?
                                    `<span class="status status-completed" style="margin-left: 10px;">‚úÖ Sp√∏rgeskema p√•begyndt</span>` :
                                    `<span class="status status-pending" style="margin-left: 10px;">‚è≥ Ikke udfyldt</span>`
                                }
                            </div>
                        </div>
                    `;
                });
            }

            document.getElementById('employeesList').innerHTML = html;
        }

        function showEmployeeDetail(email) {
            currentEmployeeDetail = email;
            const data = getAllMUSData()[email];

            document.getElementById('detailEmployeeName').textContent = data.name;

            // Booking info
            let bookingHtml = '';
            if (data.booking) {
                bookingHtml = `
                    <strong>üìÖ LUS-booking:</strong><br>
                    Dato: ${data.booking.date}<br>
                    Tidspunkt: ${data.booking.time}<br>
                    ${data.booking.notes ? `Bem√¶rkninger: ${data.booking.notes}` : ''}
                `;
            } else {
                bookingHtml = '<strong>‚è≥ Teamlederen har ikke booket en LUS-tid endnu</strong>';
            }
            document.getElementById('detailBookingInfo').innerHTML = bookingHtml;

            // Answers with leader comments
            let answersHtml = '<h3>Teamlederens svar og dine kommentarer</h3>';
            
            data.answers.forEach((section, sectionIndex) => {
                answersHtml += `<div class="question-section">`;
                answersHtml += `<h3>${section.section}</h3>`;

                section.questions.forEach((q, qIndex) => {
                    answersHtml += `<div class="question">`;
                    answersHtml += `<label class="question-label">${qIndex + 1}. ${q.text}</label>`;

                    if (q.type === 'textarea') {
                        const answer = q.answer || '<em style="color: #999;">Ikke besvaret endnu</em>';
                        answersHtml += `<div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #e0e0e0; margin-bottom: 15px;">
                            <strong>Teamlederens svar:</strong><br>${answer}
                        </div>`;
                        
                        // Leader comment field
                        answersHtml += `<label style="color: #1a4d3e; font-weight: 600; margin-top: 10px;">Dine kommentarer / Aftaler:</label>`;
                        answersHtml += `<textarea 
                            id="leader_comment_${q.id}" 
                            onblur="saveLeaderComment('${q.id}')"
                            style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #1a4d3e; border-radius: 8px; font-size: 14px;"
                            placeholder="Skriv dine kommentarer eller aftaler her..."
                        >${q.leaderComment || ''}</textarea>`;
                        
                    } else if (q.type === 'scale') {
                        const answer = q.answer || '<em style="color: #999;">Ikke besvaret</em>';
                        answersHtml += `<div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #e0e0e0; margin-bottom: 10px;">
                            <strong>Vurdering:</strong> ${answer}
                        </div>`;
                        
                        if (q.followup) {
                            answersHtml += `<div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #e0e0e0; margin-bottom: 15px;">
                                <strong>Teamlederens uddybning:</strong><br>${q.followup}
                            </div>`;
                        }
                        
                        // Leader comment field
                        answersHtml += `<label style="color: #1a4d3e; font-weight: 600; margin-top: 10px;">Dine kommentarer / Aftaler:</label>`;
                        answersHtml += `<textarea 
                            id="leader_comment_${q.id}" 
                            onblur="saveLeaderComment('${q.id}')"
                            style="width: 100%; min-height: 100px; padding: 12px; border: 2px solid #1a4d3e; border-radius: 8px; font-size: 14px;"
                            placeholder="Skriv dine kommentarer eller aftaler her..."
                        >${q.leaderComment || ''}</textarea>`;
                    }

                    answersHtml += `</div>`;
                });

                answersHtml += `</div>`;
            });

            document.getElementById('detailAnswers').innerHTML = answersHtml;
            showScreen('employeeDetailScreen');
        }

        function backToLeaderDashboard() {
            currentEmployeeDetail = null;
            showLeaderDashboard();
        }

        function saveLeaderComment(questionId) {
            const email = currentEmployeeDetail;
            const userData = getAllMUSData()[email];
            
            // Find the question and save leader comment
            for (let section of userData.answers) {
                for (let q of section.questions) {
                    if (q.id === questionId) {
                        const commentField = document.getElementById(`leader_comment_${questionId}`);
                        if (commentField) {
                            q.leaderComment = commentField.value;
                        }
                        break;
                    }
                }
            }

            saveMUSData(email, userData);
        }

        // Questions Editor
        function renderQuestionsEditor() {
            const questions = getQuestions();
            
            let html = '';

            questions.forEach((section, sIndex) => {
                html += `<div class="question-section">`;
                html += `<h3>${section.section}</h3>`;

                section.questions.forEach((q, qIndex) => {
                    html += `<div class="question-editor">`;
                    html += `<label><strong>Sp√∏rgsm√•l ${qIndex + 1}:</strong></label>`;
                    html += `<textarea id="edit_${q.id}">${q.text}</textarea>`;
                    html += `<p style="color: #666; font-size: 0.9em; margin-top: 5px;">Type: ${q.type === 'textarea' ? '√Öben tekst' : 'Skala + uddybning'}</p>`;
                    html += `</div>`;
                });

                html += `</div>`;
            });

            document.getElementById('questionsEditor').innerHTML = html;
        }

        function saveQuestions() {
            const questions = getQuestions();

            questions.forEach((section) => {
                section.questions.forEach((q) => {
                    const textarea = document.getElementById(`edit_${q.id}`);
                    if (textarea) {
                        q.text = textarea.value;
                    }
                });
            });

            saveQuestionsToStorage(questions);
            alert('‚úÖ Sp√∏rgsm√•l gemt! Nye teamledere vil f√• de opdaterede sp√∏rgsm√•l.');
        }

        // Export to PDF
        function exportToPDF() {
            // Check if jsPDF library is loaded
            if (typeof window.jspdf === 'undefined') {
                alert('‚ö†Ô∏è PDF-biblioteket er ikke loaded endnu.\n\nVent et √∏jeblik og pr√∏v igen.');
                return;
            }

            const email = currentEmployeeDetail;
            const data = getAllMUSData()[email];

            try {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();
                
                let yPos = 20;
                const pageHeight = doc.internal.pageSize.height;
                const margin = 20;
                const maxWidth = 170;
                
                // Helper function to add text with page break
                function addText(text, fontSize = 12, isBold = false, addSpace = 5) {
                    if (yPos > pageHeight - 20) {
                        doc.addPage();
                        yPos = 20;
                    }
                    
                    doc.setFontSize(fontSize);
                    doc.setFont(undefined, isBold ? 'bold' : 'normal');
                    
                    const lines = doc.splitTextToSize(text, maxWidth);
                    lines.forEach(line => {
                        if (yPos > pageHeight - 20) {
                            doc.addPage();
                            yPos = 20;
                        }
                        doc.text(line, margin, yPos);
                        yPos += fontSize * 0.5;
                    });
                    yPos += addSpace;
                }
                
                // Title
                addText('Lederudviklingssamtale (LUS)', 18, true, 10);
                
                // Header info
                addText(`Teamleder: ${data.name}`, 12, false, 3);
                addText(`Organisation: Handicap`, 12, false, 3);
                addText(`Dato: ${new Date().toLocaleDateString('da-DK')}`, 12, false, 10);
                
                // Booking info
                if (data.booking) {
                    addText(`LUS-samtale booket: ${data.booking.date} kl. ${data.booking.time}`, 11, false, 10);
                }
                
                // All answers and leader comments
                data.answers.forEach((section, sIdx) => {
                    // Section header
                    addText(section.section, 14, true, 8);
                    
                    section.questions.forEach((q, qIdx) => {
                        // Question
                        addText(`${qIdx + 1}. ${q.text}`, 11, true, 5);
                        
                        if (q.type === 'textarea') {
                            // Employee answer
                            addText('Teamlederens svar:', 10, true, 3);
                            addText(q.answer || 'Ikke besvaret', 10, false, 5);
                            
                            // Leader comment
                            if (q.leaderComment) {
                                addText('Lederens kommentarer / Aftaler:', 10, true, 3);
                                addText(q.leaderComment, 10, false, 8);
                            } else {
                                yPos += 3;
                            }
                            
                        } else if (q.type === 'scale') {
                            // Employee rating
                            addText(`Vurdering: ${q.answer || 'Ikke besvaret'}`, 10, false, 3);
                            
                            // Employee followup
                            if (q.followup) {
                                addText('Teamlederens uddybning:', 10, true, 3);
                                addText(q.followup, 10, false, 5);
                            }
                            
                            // Leader comment
                            if (q.leaderComment) {
                                addText('Lederens kommentarer / Aftaler:', 10, true, 3);
                                addText(q.leaderComment, 10, false, 8);
                            } else {
                                yPos += 3;
                            }
                        }
                    });
                });
                
                // Signature section
                yPos += 15;
                addText('Underskrifter', 14, true, 10);
                
                // Employee signature
                addText('Teamleder:', 11, true, 5);
                addText('_________________________________________', 11, false, 3);
                addText(`${data.name}`, 10, false, 3);
                addText(`Dato: _____________________`, 10, false, 10);
                
                // Leader signature
                addText('Ledelse:', 11, true, 5);
                addText('_________________________________________', 11, false, 3);
                addText('Lilli Ane', 10, false, 3);
                addText(`Dato: _____________________`, 10, false, 10);
                
                // Save PDF
                doc.save(`LUS_${data.name}_${new Date().toISOString().split('T')[0]}.pdf`);
                
                // Ask to delete data
                setTimeout(() => {
                    if (confirm(`PDF-dokument gemt!\n\nVil du slette ${data.name}'s data fra systemet?\n\n(Data skal slettes n√•r LUS er afholdt og dokumentet er arkiveret)`)) {
                        const allData = getAllMUSData();
                        delete allData[email];
                        localStorage.setItem('lusDataHandicap', JSON.stringify(allData));
                        
                        alert('‚úÖ Data slettet fra systemet');
                        backToLeaderDashboard();
                    }
                }, 500);
                
            } catch (error) {
                console.error('PDF export error:', error);
                alert('‚ùå Der opstod en fejl ved eksport til PDF.\n\nFejl: ' + error.message + '\n\nPr√∏v at genindl√¶se siden (F5) og fors√∏g igen.');
            }
        }

        // Initialize on load
        window.onload = function() {
            initStorage();
            
            // Check if libraries loaded correctly
            setTimeout(() => {
                if (typeof window.jspdf === 'undefined') {
                    console.error('jsPDF library failed to load from CDN');
                }
            }, 2000);
        };
    </script>
</body>
</html>