<!DOCTYPE html>
<html lang="da">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MUS System - Katrinehaven</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 900px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.2);
            padding: 40px;
        }

        .header {
            text-align: center;
            margin-bottom: 40px;
        }

        .header h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .header p {
            color: #666;
            font-size: 1.1em;
        }

        .screen {
            display: none;
        }

        .screen.active {
            display: block;
            animation: fadeIn 0.5s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .form-group {
            margin-bottom: 25px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }

        input[type="email"],
        input[type="text"],
        input[type="password"],
        textarea,
        select {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input:focus,
        textarea:focus,
        select:focus {
            outline: none;
            border-color: #667eea;
        }

        textarea {
            min-height: 120px;
            resize: vertical;
        }

        .btn {
            background: #667eea;
            color: white;
            border: none;
            padding: 14px 30px;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            width: 100%;
            margin-top: 10px;
        }

        .btn:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #6c757d;
        }

        .btn-secondary:hover {
            background: #5a6268;
        }

        .btn-danger {
            background: #dc3545;
        }

        .btn-danger:hover {
            background: #c82333;
        }

        .btn-success {
            background: #28a745;
        }

        .btn-success:hover {
            background: #218838;
        }

        .code-display {
            background: #f8f9fa;
            border: 2px dashed #667eea;
            border-radius: 8px;
            padding: 20px;
            text-align: center;
            margin: 20px 0;
        }

        .code-display .code {
            font-size: 2em;
            font-weight: bold;
            color: #667eea;
            letter-spacing: 5px;
        }

        .alert {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
        }

        .alert-info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .alert-success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .alert-danger {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .question-section {
            background: #f8f9fa;
            border-radius: 10px;
            padding: 25px;
            margin-bottom: 30px;
        }

        .question-section h3 {
            color: #667eea;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #667eea;
        }

        .question {
            margin-bottom: 25px;
        }

        .question-label {
            font-weight: 600;
            color: #333;
            margin-bottom: 10px;
            display: block;
        }

        .radio-group {
            display: flex;
            gap: 15px;
            flex-wrap: wrap;
            margin: 10px 0;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .radio-option input[type="radio"] {
            width: auto;
        }

        .employee-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 15px;
            cursor: pointer;
            transition: all 0.3s;
        }

        .employee-card:hover {
            border-color: #667eea;
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.2);
        }

        .employee-card h4 {
            color: #333;
            margin-bottom: 10px;
        }

        .employee-card .status {
            display: inline-block;
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .status-pending {
            background: #fff3cd;
            color: #856404;
        }

        .status-completed {
            background: #d4edda;
            color: #155724;
        }

        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab {
            padding: 12px 24px;
            background: none;
            border: none;
            color: #666;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
        }

        .tab:hover {
            color: #667eea;
        }

        .question-editor {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .question-editor textarea {
            min-height: 60px;
        }

        .navigation-buttons {
            display: flex;
            gap: 10px;
            margin-top: 30px;
        }

        .navigation-buttons button {
            flex: 1;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
            }

            .header h1 {
                font-size: 1.8em;
            }

            .radio-group {
                flex-direction: column;
            }

            .navigation-buttons {
                flex-direction: column;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üåü MUS System</h1>
            <p>Katrinehaven - Medarbejderudviklingssamtaler</p>
        </div>

        <!-- Login Screen -->
        <div id="loginScreen" class="screen active">
            <div class="form-group">
                <label for="loginType">V√¶lg logintype:</label>
                <select id="loginType" onchange="toggleLoginType()">
                    <option value="employee">Medarbejder</option>
                    <option value="leader">Leder</option>
                </select>
            </div>

            <div id="employeeLogin">
                <div class="form-group">
                    <label for="employeeEmail">Din arbejds-email:</label>
                    <input type="email" id="employeeEmail" placeholder="din.email@viborg.dk">
                </div>
                <div class="form-group">
                    <label for="employeeCluster">V√¶lg din klynge:</label>
                    <select id="employeeCluster">
                        <option value="">-- V√¶lg klynge --</option>
                        <option value="1">Klynge 1</option>
                        <option value="2">Klynge 2</option>
                        <option value="3">Klynge 3</option>
                        <option value="4">Klynge 4</option>
                        <option value="5">Klynge 5</option>
                        <option value="6">Klynge 6</option>
                        <option value="7">Klynge 7</option>
                    </select>
                </div>
                <button class="btn" onclick="sendCode()">Send engangskode</button>
            </div>

            <div id="leaderLogin" style="display: none;">
                <div class="form-group">
                    <label for="leaderPassword">Leder-adgangskode:</label>
                    <input type="password" id="leaderPassword" placeholder="Indtast adgangskode">
                </div>
                <button class="btn" onclick="leaderLogin()">Log ind som leder</button>
            </div>
        </div>

        <!-- Code Verification Screen -->
        <div id="codeScreen" class="screen">
            <div class="alert alert-info">
                <strong>üìß Engangskode sendt!</strong><br>
                Din engangskode er vist nedenfor. I fremtiden vil den blive sendt til din email.
            </div>
            
            <div class="code-display">
                <p>Din engangskode:</p>
                <div class="code" id="displayedCode"></div>
            </div>

            <div class="form-group">
                <label for="codeInput">Indtast engangskode:</label>
                <input type="text" id="codeInput" placeholder="Indtast 4-cifret kode" maxlength="4">
            </div>

            <button class="btn" onclick="verifyCode()">Verificer kode</button>
            <button class="btn btn-secondary" onclick="goToLogin()">Tilbage</button>
        </div>

        <!-- Employee Dashboard -->
        <div id="employeeDashboard" class="screen">
            <div class="alert alert-success">
                Velkommen, <span id="employeeName"></span>!
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showEmployeeTab('booking')">üìÖ Book MUS</button>
                <button class="tab" onclick="showEmployeeTab('questionnaire')">üìù Sp√∏rgeskema</button>
            </div>

            <!-- Booking Tab -->
            <div id="bookingTab" class="tab-content">
                <h3>Book din MUS-samtale</h3>
                <p style="margin-bottom: 20px; color: #666;">
                    Tjek din leders kalender i Outlook og v√¶lg en ledig tid nedenfor.
                </p>

                <div class="form-group">
                    <label for="musDate">√ònsket dato:</label>
                    <input type="date" id="musDate">
                </div>

                <div class="form-group">
                    <label for="musTime">√ònsket tidspunkt:</label>
                    <input type="time" id="musTime">
                </div>

                <div class="form-group">
                    <label for="musNotes">Evt. bem√¶rkninger:</label>
                    <textarea id="musNotes" placeholder="F.eks. 'Jeg har allerede tjekket at du er ledig denne dag'"></textarea>
                </div>

                <button class="btn" onclick="bookMUS()">Send booking-anmodning</button>
            </div>

            <!-- Questionnaire Tab -->
            <div id="questionnaireTab" class="tab-content" style="display: none;">
                <div id="questionnaireForm"></div>
            </div>

            <button class="btn btn-secondary" onclick="logout()" style="margin-top: 30px;">Log ud</button>
        </div>

        <!-- Leader Dashboard -->
        <div id="leaderDashboard" class="screen">
            <div class="alert alert-success">
                Velkommen til leder-panelet!
            </div>

            <div class="form-group" style="margin-bottom: 30px;">
                <label for="leaderClusterSelect">V√¶lg klynge at se:</label>
                <select id="leaderClusterSelect" onchange="changeLeaderCluster()">
                    <option value="">-- V√¶lg klynge --</option>
                    <option value="1">Klynge 1</option>
                    <option value="2">Klynge 2</option>
                    <option value="3">Klynge 3</option>
                    <option value="4">Klynge 4</option>
                    <option value="5">Klynge 5</option>
                    <option value="6">Klynge 6</option>
                    <option value="7">Klynge 7</option>
                </select>
            </div>

            <div class="tabs">
                <button class="tab active" onclick="showLeaderTab('employees')">üë• Medarbejdere</button>
                <button class="tab" onclick="showLeaderTab('questions')">‚öôÔ∏è Rediger sp√∏rgsm√•l</button>
            </div>

            <!-- Employees Tab -->
            <div id="employeesTab" class="tab-content">
                <h3>Alle medarbejderes MUS</h3>
                <div id="employeesList"></div>
            </div>

            <!-- Questions Tab -->
            <div id="questionsTab" class="tab-content" style="display: none;">
                <h3>Rediger standard MUS-sp√∏rgsm√•l</h3>
                <p style="margin-bottom: 20px; color: #666;">
                    Disse sp√∏rgsm√•l er f√¶lles for alle medarbejdere. Du kan redigere dem her.
                </p>
                <div id="questionsEditor"></div>
                <button class="btn btn-success" onclick="saveQuestions()">Gem √¶ndringer</button>
            </div>

            <button class="btn btn-secondary" onclick="logout()" style="margin-top: 30px;">Log ud</button>
        </div>

        <!-- Employee Detail View -->
        <div id="employeeDetailScreen" class="screen">
            <button class="btn btn-secondary" onclick="backToLeaderDashboard()" style="margin-bottom: 20px;">‚Üê Tilbage til oversigt</button>
            
            <h2 id="detailEmployeeName"></h2>
            <div id="detailBookingInfo" class="alert alert-info"></div>
            
            <div id="detailAnswers"></div>

            <div class="navigation-buttons">
                <button class="btn btn-success" onclick="exportToWord()">üìÑ Gem som Word-dokument</button>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/docx/7.8.2/docx.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    <script>
        // State management
        let currentUser = null;
        let currentCode = null;
        let isLeader = false;
        let currentEmployeeDetail = null;
        let selectedLeaderCluster = null;

        // Default leader password - CHANGE THIS!
        const LEADER_PASSWORD = "leder2024";

        // Default questions from HR
        const DEFAULT_QUESTIONS = [
            {
                section: "Opf√∏lgning siden sidst",
                questions: [
                    {
                        id: "q1",
                        text: "Hvordan er det g√•et med opf√∏lgning p√• aftaler om udvikling?",
                        type: "textarea",
                        answer: ""
                    },
                    {
                        id: "q2",
                        text: "Hvad er g√•et godt, og hvad kendetegner de situationer eller opgaver?",
                        type: "textarea",
                        answer: ""
                    },
                    {
                        id: "q3",
                        text: "Hvad ville jeg gerne v√¶re lykkedes bedre med? Og hvad skulle have v√¶ret anderledes, for at n√• i m√•l?",
                        type: "textarea",
                        answer: ""
                    },
                    {
                        id: "q4",
                        text: "Hvilke resultater er jeg mest glad for at have opn√•et?",
                        type: "textarea",
                        answer: ""
                    }
                ]
            },
            {
                section: "Organisatoriske rammer og opgaver",
                questions: [
                    {
                        id: "q5",
                        text: "Jeg har kendskab til de rammer, m√•ls√¶tninger og prioriteringer som arbejdspladsen arbejder efter",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q6",
                        text: "Min n√¶rmeste leder er god til at s√¶tte klare m√•l for arbejdspladsen",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q7",
                        text: "Jeg form√•r at bidrage aktivt og konstruktivt til arbejdspladsens udvikling og opgavel√∏sning",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q8",
                        text: "Jeg har en forst√•else for min rolle p√• arbejdspladsen og ved hvilke kompetencer jeg kan byde ind med",
                        type: "scale",
                        answer: "",
                        followup: ""
                    }
                ]
            },
            {
                section: "Relationer og samarbejde",
                questions: [
                    {
                        id: "q9",
                        text: "Jeg bidrager aktivt til et godt samarbejde med kolleger, samarbejdspartnere og ledere",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q10",
                        text: "Jeg tager ansvar for f√¶lles resultatskabelse og f√¶lles arbejdsgl√¶de og trivsel",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q11",
                        text: "Jeg kan f√• st√∏tte og vejledning, n√•r jeg har behov for det",
                        type: "scale",
                        answer: "",
                        followup: ""
                    },
                    {
                        id: "q12",
                        text: "Jeg f√•r tilbagemeldinger om kvalitet af det arbejde, jeg udf√∏rer",
                        type: "scale",
                        answer: "",
                        followup: ""
                    }
                ]
            },
            {
                section: "Kompetencer og udvikling",
                questions: [
                    {
                        id: "q13",
                        text: "Hvor ser jeg mit behov for udvikling i kompetencer og opgaver ift. arbejdspladsens opgavel√∏sning?",
                        type: "textarea",
                        answer: ""
                    },
                    {
                        id: "q14",
                        text: "Jeg har mulighed for at l√¶re nyt og udvikle mig gennem mit arbejde",
                        type: "scale",
                        answer: "",
                        followup: ""
                    }
                ]
            },
            {
                section: "Tilknytning til arbejdspladsen",
                questions: [
                    {
                        id: "q15",
                        text: "N√•r vi har MUS-samtale igen til n√¶ste √•r (eller om 5 √•r), hvad har s√• v√¶ret medvirkende til at vi har kunne fastholde dig?",
                        type: "textarea",
                        answer: ""
                    },
                    {
                        id: "q16",
                        text: "Er der s√¶rlige forhold, vi som arbejdsplads skal tage hensyn til/b√∏r kende for at sikre din fortsatte tilknytning?",
                        type: "textarea",
                        answer: ""
                    },
                    {
                        id: "q17",
                        text: "Er der behov for at kigge p√• arbejds- og opgavetilrettel√¶ggelse/ressourcer i forhold til tilknytning p√• kort og langt sigt?",
                        type: "textarea",
                        answer: ""
                    }
                ]
            },
            {
                section: "Konkrete aftaler om udvikling",
                questions: [
                    {
                        id: "q18",
                        text: "Hvilke 1-2 udviklingsm√•l er relevante for det kommende √•r? Hvilke indsatser kr√¶ver de?",
                        type: "textarea",
                        answer: ""
                    }
                ]
            }
        ];

        // Initialize localStorage
        function initStorage() {
            if (!localStorage.getItem('musData')) {
                localStorage.setItem('musData', JSON.stringify({}));
            }
            if (!localStorage.getItem('musQuestions')) {
                localStorage.setItem('musQuestions', JSON.stringify(DEFAULT_QUESTIONS));
            }
        }

        // Get all MUS data
        function getAllMUSData() {
            return JSON.parse(localStorage.getItem('musData') || '{}');
        }

        // Save MUS data
        function saveMUSData(email, data) {
            const allData = getAllMUSData();
            allData[email] = data;
            localStorage.setItem('musData', JSON.stringify(allData));
        }

        // Get questions
        function getQuestions() {
            return JSON.parse(localStorage.getItem('musQuestions') || JSON.stringify(DEFAULT_QUESTIONS));
        }

        // Save questions
        function saveQuestionsToStorage(questions) {
            localStorage.setItem('musQuestions', JSON.stringify(questions));
        }

        // Login functions
        function toggleLoginType() {
            const type = document.getElementById('loginType').value;
            document.getElementById('employeeLogin').style.display = type === 'employee' ? 'block' : 'none';
            document.getElementById('leaderLogin').style.display = type === 'leader' ? 'block' : 'none';
        }

        function sendCode() {
            const email = document.getElementById('employeeEmail').value.trim();
            const cluster = document.getElementById('employeeCluster').value;
            
            if (!email || !email.includes('@')) {
                alert('Indtast venligst en gyldig email-adresse');
                return;
            }

            if (!cluster) {
                alert('V√¶lg venligst din klynge');
                return;
            }

            // Check if user already exists and has a permanent code
            const allData = getAllMUSData();
            let permanentCode;
            
            if (allData[email] && allData[email].permanentCode) {
                // Use existing permanent code
                permanentCode = allData[email].permanentCode;
            } else {
                // Generate new permanent 4-digit code for first-time user
                permanentCode = Math.floor(1000 + Math.random() * 9000).toString();
                
                // Save the permanent code immediately
                if (!allData[email]) {
                    allData[email] = {
                        name: email.split('@')[0],
                        email: email,
                        cluster: cluster,
                        permanentCode: permanentCode,
                        booking: null,
                        answers: getQuestions()
                    };
                } else {
                    allData[email].permanentCode = permanentCode;
                }
                saveMUSData(email, allData[email]);
            }

            currentCode = permanentCode;
            currentUser = { 
                email: email, 
                name: email.split('@')[0],
                cluster: cluster
            };

            // Show code screen with message about permanent code
            const isFirstTime = !allData[email] || !allData[email].permanentCode;
            document.getElementById('displayedCode').textContent = currentCode;
            
            // Update message based on first time or returning user
            const codeMessage = document.querySelector('#codeScreen .alert');
            if (isFirstTime) {
                codeMessage.innerHTML = `
                    <strong>üìß Din personlige engangskode!</strong><br>
                    Dette er din <strong>faste kode</strong>. Gem den godt - du skal bruge den samme kode hver gang du logger ind.
                `;
            } else {
                codeMessage.innerHTML = `
                    <strong>üìß Velkommen tilbage!</strong><br>
                    Indtast din faste kode nedenfor. (Det er den samme kode som sidst)
                `;
            }
            
            showScreen('codeScreen');
        }

        function verifyCode() {
            const inputCode = document.getElementById('codeInput').value;

            if (inputCode === currentCode) {
                isLeader = false;
                
                // Initialize or update user data
                const allData = getAllMUSData();
                if (!allData[currentUser.email]) {
                    allData[currentUser.email] = {
                        name: currentUser.name,
                        email: currentUser.email,
                        cluster: currentUser.cluster,
                        permanentCode: currentCode,
                        booking: null,
                        answers: getQuestions()
                    };
                    saveMUSData(currentUser.email, allData[currentUser.email]);
                } else {
                    // Update cluster if it changed
                    allData[currentUser.email].cluster = currentUser.cluster;
                    // Ensure permanent code is saved
                    if (!allData[currentUser.email].permanentCode) {
                        allData[currentUser.email].permanentCode = currentCode;
                    }
                    saveMUSData(currentUser.email, allData[currentUser.email]);
                }

                showEmployeeDashboard();
            } else {
                alert('Forkert kode. Pr√∏v igen.');
            }
        }

        function leaderLogin() {
            const password = document.getElementById('leaderPassword').value;

            if (password === LEADER_PASSWORD) {
                isLeader = true;
                selectedLeaderCluster = null;
                showLeaderDashboard();
            } else {
                alert('Forkert adgangskode');
            }
        }

        function logout() {
            currentUser = null;
            currentCode = null;
            isLeader = false;
            document.getElementById('employeeEmail').value = '';
            document.getElementById('leaderPassword').value = '';
            document.getElementById('codeInput').value = '';
            showScreen('loginScreen');
        }

        function goToLogin() {
            document.getElementById('codeInput').value = '';
            showScreen('loginScreen');
        }

        // Screen navigation
        function showScreen(screenId) {
            document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
            document.getElementById(screenId).classList.add('active');
        }

        // Employee Dashboard
        function showEmployeeDashboard() {
            document.getElementById('employeeName').textContent = currentUser.name;
            renderQuestionnaire();
            showScreen('employeeDashboard');
        }

        function showEmployeeTab(tab) {
            document.querySelectorAll('#employeeDashboard .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('bookingTab').style.display = tab === 'booking' ? 'block' : 'none';
            document.getElementById('questionnaireTab').style.display = tab === 'questionnaire' ? 'block' : 'none';
        }

        function bookMUS() {
            const date = document.getElementById('musDate').value;
            const time = document.getElementById('musTime').value;
            const notes = document.getElementById('musNotes').value;

            if (!date || !time) {
                alert('V√¶lg venligst b√•de dato og tidspunkt');
                return;
            }

            const booking = {
                date: date,
                time: time,
                notes: notes,
                bookedAt: new Date().toISOString()
            };

            const userData = getAllMUSData()[currentUser.email];
            userData.booking = booking;
            saveMUSData(currentUser.email, userData);

            alert(`‚úÖ MUS-booking sendt!\n\nDato: ${date}\nTidspunkt: ${time}\n\nDin leder har modtaget din anmodning via email.`);
            
            // Clear form
            document.getElementById('musDate').value = '';
            document.getElementById('musTime').value = '';
            document.getElementById('musNotes').value = '';
        }

        // Questionnaire rendering
        function renderQuestionnaire() {
            const userData = getAllMUSData()[currentUser.email];
            const questions = userData.answers;
            
            let html = '<h3>Udfyld dit MUS-sp√∏rgeskema</h3>';
            html += '<p style="margin-bottom: 30px; color: #666;">Udfyld sp√∏rgeskemaet som forberedelse til din MUS-samtale. Dine svar gemmes automatisk.</p>';

            questions.forEach((section, sIndex) => {
                html += `<div class="question-section">`;
                html += `<h3>${section.section}</h3>`;

                section.questions.forEach((q, qIndex) => {
                    html += `<div class="question">`;
                    html += `<label class="question-label">${qIndex + 1}. ${q.text}</label>`;

                    if (q.type === 'textarea') {
                        html += `<textarea id="answer_${q.id}" onblur="saveAnswer('${q.id}')">${q.answer || ''}</textarea>`;
                    } else if (q.type === 'scale') {
                        const options = [
                            'I meget h√∏j grad',
                            'I h√∏j grad',
                            'I nogen grad',
                            'I mindre grad',
                            'Slet ikke'
                        ];
                        
                        html += `<div class="radio-group">`;
                        options.forEach(opt => {
                            const checked = q.answer === opt ? 'checked' : '';
                            html += `
                                <div class="radio-option">
                                    <input type="radio" name="scale_${q.id}" value="${opt}" ${checked} onchange="saveAnswer('${q.id}')">
                                    <label>${opt}</label>
                                </div>
                            `;
                        });
                        html += `</div>`;
                        html += `<label style="margin-top: 15px;">Uddyb gerne:</label>`;
                        html += `<textarea id="followup_${q.id}" onblur="saveFollowup('${q.id}')" style="min-height: 80px;">${q.followup || ''}</textarea>`;
                    }

                    html += `</div>`;
                });

                html += `</div>`;
            });

            document.getElementById('questionnaireForm').innerHTML = html;
        }

        function saveAnswer(questionId) {
            const userData = getAllMUSData()[currentUser.email];
            
            // Find the question
            for (let section of userData.answers) {
                for (let q of section.questions) {
                    if (q.id === questionId) {
                        if (q.type === 'textarea') {
                            q.answer = document.getElementById(`answer_${questionId}`).value;
                        } else if (q.type === 'scale') {
                            const selected = document.querySelector(`input[name="scale_${questionId}"]:checked`);
                            q.answer = selected ? selected.value : '';
                        }
                        break;
                    }
                }
            }

            saveMUSData(currentUser.email, userData);
        }

        function saveFollowup(questionId) {
            const userData = getAllMUSData()[currentUser.email];
            
            for (let section of userData.answers) {
                for (let q of section.questions) {
                    if (q.id === questionId) {
                        q.followup = document.getElementById(`followup_${questionId}`).value;
                        break;
                    }
                }
            }

            saveMUSData(currentUser.email, userData);
        }

        // Leader Dashboard
        function showLeaderDashboard() {
            document.getElementById('leaderClusterSelect').value = selectedLeaderCluster || '';
            renderEmployeesList();
            renderQuestionsEditor();
            showScreen('leaderDashboard');
        }

        function changeLeaderCluster() {
            selectedLeaderCluster = document.getElementById('leaderClusterSelect').value;
            renderEmployeesList();
        }

        function showLeaderTab(tab) {
            document.querySelectorAll('#leaderDashboard .tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.getElementById('employeesTab').style.display = tab === 'employees' ? 'block' : 'none';
            document.getElementById('questionsTab').style.display = tab === 'questions' ? 'block' : 'none';
        }

        function renderEmployeesList() {
            const allData = getAllMUSData();
            const emails = Object.keys(allData);

            let html = '';

            if (!selectedLeaderCluster) {
                html = '<p style="color: #666; text-align: center; padding: 40px;">üëÜ V√¶lg venligst en klynge ovenfor for at se medarbejdere</p>';
            } else {
                // Filter by selected cluster
                const filteredEmails = emails.filter(email => allData[email].cluster === selectedLeaderCluster);

                if (filteredEmails.length === 0) {
                    html = `<p style="color: #666; text-align: center; padding: 40px;">Ingen medarbejdere i Klynge ${selectedLeaderCluster} endnu.</p>`;
                } else {
                    filteredEmails.forEach(email => {
                        const data = allData[email];
                        const hasBooking = data.booking !== null;
                        const hasAnswers = data.answers.some(s => s.questions.some(q => q.answer));

                        html += `
                            <div class="employee-card" onclick="showEmployeeDetail('${email}')">
                                <h4>${data.name}</h4>
                                <p style="color: #666; margin-bottom: 10px;">${email} ‚Ä¢ Klynge ${data.cluster}</p>
                                <div>
                                    ${hasBooking ? 
                                        `<span class="status status-completed">üìÖ Booket: ${data.booking.date} kl. ${data.booking.time}</span>` :
                                        `<span class="status status-pending">‚è≥ Ikke booket</span>`
                                    }
                                    ${hasAnswers ?
                                        `<span class="status status-completed" style="margin-left: 10px;">‚úÖ Sp√∏rgeskema p√•begyndt</span>` :
                                        `<span class="status status-pending" style="margin-left: 10px;">‚è≥ Ikke udfyldt</span>`
                                    }
                                </div>
                            </div>
                        `;
                    });
                }
            }

            document.getElementById('employeesList').innerHTML = html;
        }

        function showEmployeeDetail(email) {
            currentEmployeeDetail = email;
            const data = getAllMUSData()[email];

            document.getElementById('detailEmployeeName').textContent = `${data.name} - Klynge ${data.cluster}`;

            // Booking info
            let bookingHtml = '';
            if (data.booking) {
                bookingHtml = `
                    <strong>üìÖ MUS-booking:</strong><br>
                    Dato: ${data.booking.date}<br>
                    Tidspunkt: ${data.booking.time}<br>
                    ${data.booking.notes ? `Bem√¶rkninger: ${data.booking.notes}` : ''}
                `;
            } else {
                bookingHtml = '<strong>‚è≥ Medarbejderen har ikke booket en MUS-tid endnu</strong>';
            }
            document.getElementById('detailBookingInfo').innerHTML = bookingHtml;

            // Answers
            let answersHtml = '<h3>Medarbejderens svar</h3>';
            
            data.answers.forEach((section) => {
                answersHtml += `<div class="question-section">`;
                answersHtml += `<h3>${section.section}</h3>`;

                section.questions.forEach((q, idx) => {
                    answersHtml += `<div class="question">`;
                    answersHtml += `<label class="question-label">${idx + 1}. ${q.text}</label>`;

                    if (q.type === 'textarea') {
                        const answer = q.answer || '<em style="color: #999;">Ikke besvaret endnu</em>';
                        answersHtml += `<div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #e0e0e0;">${answer}</div>`;
                    } else if (q.type === 'scale') {
                        const answer = q.answer || '<em style="color: #999;">Ikke besvaret</em>';
                        answersHtml += `<div style="background: white; padding: 10px; border-radius: 5px; border: 1px solid #e0e0e0; margin-bottom: 10px;"><strong>${answer}</strong></div>`;
                        
                        if (q.followup) {
                            answersHtml += `<label style="margin-top: 10px;">Uddybning:</label>`;
                            answersHtml += `<div style="background: white; padding: 15px; border-radius: 5px; border: 1px solid #e0e0e0;">${q.followup}</div>`;
                        }
                    }

                    answersHtml += `</div>`;
                });

                answersHtml += `</div>`;
            });

            document.getElementById('detailAnswers').innerHTML = answersHtml;
            showScreen('employeeDetailScreen');
        }

        function backToLeaderDashboard() {
            currentEmployeeDetail = null;
            showLeaderDashboard();
        }

        // Questions Editor
        function renderQuestionsEditor() {
            const questions = getQuestions();
            
            let html = '';

            questions.forEach((section, sIndex) => {
                html += `<div class="question-section">`;
                html += `<h3>${section.section}</h3>`;

                section.questions.forEach((q, qIndex) => {
                    html += `<div class="question-editor">`;
                    html += `<label><strong>Sp√∏rgsm√•l ${qIndex + 1}:</strong></label>`;
                    html += `<textarea id="edit_${q.id}">${q.text}</textarea>`;
                    html += `<p style="color: #666; font-size: 0.9em; margin-top: 5px;">Type: ${q.type === 'textarea' ? '√Öben tekst' : 'Skala + uddybning'}</p>`;
                    html += `</div>`;
                });

                html += `</div>`;
            });

            document.getElementById('questionsEditor').innerHTML = html;
        }

        function saveQuestions() {
            const questions = getQuestions();

            questions.forEach((section) => {
                section.questions.forEach((q) => {
                    const textarea = document.getElementById(`edit_${q.id}`);
                    if (textarea) {
                        q.text = textarea.value;
                    }
                });
            });

            saveQuestionsToStorage(questions);
            alert('‚úÖ Sp√∏rgsm√•l gemt! Nye medarbejdere vil f√• de opdaterede sp√∏rgsm√•l.');
        }

        // Export to Word
        async function exportToWord() {
            const email = currentEmployeeDetail;
            const data = getAllMUSData()[email];

            const { Document, Paragraph, TextRun, HeadingLevel, AlignmentType, Packer } = docx;

            // Create document sections
            const sections = [];

            // Header
            sections.push(
                new Paragraph({
                    text: "Medarbejderudviklingssamtale (MUS)",
                    heading: HeadingLevel.HEADING_1,
                    alignment: AlignmentType.CENTER,
                }),
                new Paragraph({
                    text: `Medarbejder: ${data.name}`,
                    spacing: { before: 200, after: 100 }
                }),
                new Paragraph({
                    text: `Klynge: ${data.cluster}`,
                    spacing: { after: 100 }
                }),
                new Paragraph({
                    text: `Dato: ${new Date().toLocaleDateString('da-DK')}`,
                    spacing: { after: 400 }
                })
            );

            // Add booking info if exists
            if (data.booking) {
                sections.push(
                    new Paragraph({
                        text: `MUS-samtale booket: ${data.booking.date} kl. ${data.booking.time}`,
                        spacing: { after: 400 }
                    })
                );
            }

            // Add all answers
            data.answers.forEach((section) => {
                sections.push(
                    new Paragraph({
                        text: section.section,
                        heading: HeadingLevel.HEADING_2,
                        spacing: { before: 400, after: 200 }
                    })
                );

                section.questions.forEach((q, idx) => {
                    sections.push(
                        new Paragraph({
                            text: `${idx + 1}. ${q.text}`,
                            spacing: { before: 200, after: 100 },
                            bold: true
                        })
                    );

                    if (q.type === 'textarea') {
                        sections.push(
                            new Paragraph({
                                text: q.answer || "Ikke besvaret",
                                spacing: { after: 200 }
                            })
                        );
                    } else if (q.type === 'scale') {
                        sections.push(
                            new Paragraph({
                                text: `Vurdering: ${q.answer || "Ikke besvaret"}`,
                                spacing: { after: 100 }
                            })
                        );

                        if (q.followup) {
                            sections.push(
                                new Paragraph({
                                    text: "Uddybning:",
                                    spacing: { before: 100 },
                                    italics: true
                                }),
                                new Paragraph({
                                    text: q.followup,
                                    spacing: { after: 200 }
                                })
                            );
                        }
                    }
                });
            });

            // Create document
            const doc = new Document({
                sections: [{
                    properties: {},
                    children: sections
                }]
            });

            // Generate and save
            const blob = await Packer.toBlob(doc);
            saveAs(blob, `MUS_${data.name}_${new Date().toISOString().split('T')[0]}.docx`);

            // Ask to delete data
            if (confirm(`Word-dokument gemt!\n\nVil du slette ${data.name}'s data fra systemet?\n\n(Data skal slettes n√•r MUS er afholdt og dokumentet er lagt i P-sagen)`)) {
                const allData = getAllMUSData();
                delete allData[email];
                localStorage.setItem('musData', JSON.stringify(allData));
                
                alert('‚úÖ Data slettet fra systemet');
                backToLeaderDashboard();
            }
        }

        // Initialize on load
        window.onload = function() {
            initStorage();
        };
    </script>
</body>
</html>